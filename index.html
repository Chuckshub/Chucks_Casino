<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASINO VIDEO POKER</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0000AA;
            color: #AAAAFF;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            background: #0000AA;
            border: 8px solid #AAAAFF;
            padding: 15px 25px;
            font-size: 16px;
            line-height: 1.2;
            animation: borderPulse 3s infinite;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        @keyframes borderPulse {
            0%, 100% {
                border-color: #AAAAFF;
                box-shadow: 0 0 20px rgba(170, 170, 255, 0.5);
            }
            50% {
                border-color: #FFFF00;
                box-shadow: 0 0 30px rgba(255, 255, 0, 0.7);
            }
        }

        /* HOME SCREEN STYLES */
        #home-screen {
            text-align: center;
            position: relative;
        }

        .home-logo {
            color: #AAAAFF;
            font-size: 18px;
            margin: 20px 0;
        }

        .game-menu {
            margin: 30px auto;
        }

        .game-button {
            background: #AAAAFF;
            color: #0000AA;
            border: 4px solid #AAAAFF;
            padding: 20px 50px;
            font-size: 22px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 12px;
            min-width: 400px;
        }

        .game-button:hover {
            background: #FFFF00;
            border-color: #FFFF00;
        }

        .credit-display {
            color: #AAAAFF;
            font-size: 32px;
            font-weight: bold;
            margin: 20px 0;
        }

        /* GAME SCREEN STYLES */
        #game-screen {
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
        }

        pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            color: #AAAAFF;
        }

        //         .title {
        //             text-align: center;
        //             color: #FFFF00;
        //             font-size: 32px;
        //             font-weight: bold;
        //             letter-spacing: 10px;
        //             margin-bottom: 8px;
        //             text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        //         }

        .game-variant {
            display: none;
        }

        .pay-table {
            background: rgba(0, 0, 0, 0.4);
            border: 3px solid #FFFF00;
            margin: 10px auto;
            padding: 15px 30px;
            color: #FFFF00;
            font-size: 20px;
            font-weight: bold;
            text-align: left;
            min-height: 180px;
            white-space: pre;
            font-family: 'Courier New', monospace;
            display: inline-block;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.6);
        }

        .pay-table .highlight {
            background: #CC0000;
            color: #FFFF00;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .highlight {
            color: #FFFF00;
            font-weight: bold;
        }

        .cards-area {
            margin: 0;
            text-align: center;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .card {
            display: inline-block;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .card:hover {
            color: #FFFF00;
        }

        .card.held {
            color: #FFFF00;
        }

        .info-bar {
            margin: 10px 0;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
        }

        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            margin: 0;
            text-align: center;
            min-height: 70px;
            padding-bottom: 10px;
            background: #0000AA;
        }

        .casino-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .control-btn {
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
            color: #000000;
            border: 4px solid #000000;
            padding: 18px 35px;
            font-size: 22px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            border-radius: 8px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            box-shadow: 
                0 4px 0 #8B4513,
                0 6px 10px rgba(0,0,0,0.4);
            transition: all 0.1s;
            min-width: 160px;
        }

        .control-btn:active {
            transform: translateY(3px);
            box-shadow: 
                0 1px 0 #8B4513,
                0 3px 5px rgba(0,0,0,0.4);
        }

        .control-btn-deal {
            background: linear-gradient(180deg, #FF6B6B 0%, #CC0000 100%);
            color: #FFFF00;
            font-size: 28px;
            padding: 20px 50px;
            min-width: 200px;
        }

        .bet-display {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
            border: 6px solid #000000;
            border-radius: 50%;
            width: 140px;
            height: 130px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 
                inset 0 0 20px rgba(255,255,255,0.5),
                0 6px 15px rgba(0,0,0,0.5);
            margin: -10px 15px 0 15px;
        }

        .bet-label {
            display: none;
        }

        .bet-amount {
            font-size: 60px;
            font-weight: bold;
            color: #CC0000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
        }

        }

        button {
            background: #AAAAFF;
            color: #0000AA;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #FFFF00;
        }

        .result {
            position: absolute;
            top: 260px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: #FFFF00;
            font-size: 36px;
            font-weight: bold;
            min-height: 40px;
            z-index: 10;
        }
        
        .result:empty::before {
            content: '\00a0';
        }

        .hidden {
            display: none;
        }

        @keyframes dealCard {
            0% {
                opacity: 0;
                transform: translateX(-300px) translateY(-50px) rotate(-15deg) scale(0.8);
            }
            40% {
                opacity: 1;
            }
            70% {
                transform: translateX(10px) translateY(5px) rotate(2deg) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translateX(0) translateY(0) rotate(0deg) scale(1);
            }
        }

        @keyframes flipCard {
            0% {
                transform: rotateY(0deg) scale(1);
            }
            50% {
                transform: rotateY(90deg) scale(1.1);
            }
            100% {
                transform: rotateY(0deg) scale(1);
            }
        }

        .card-dealing {
            opacity: 0;
            animation: dealCard 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .card-flipping {
            animation: flipCard 0.4s ease-in-out;
        }

        .back-button {
            background: #AAAAFF !important;
            color: #0000AA !important;
        }

        .back-button:hover {
            background: #FFFF00 !important;
        }

        /* CALL ATTENDANT Overlay - Only on Home Screen */
        #attendant-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            display: none;
            z-index: 1000;
            pointer-events: all;
        }

        #home-screen.firebase-disconnected #attendant-overlay {
            display: block;
        }

        #home-screen.firebase-disconnected .game-button {
            pointer-events: none;
            opacity: 0.6;
        }

        .attendant-message {
            text-align: center;
            animation: flashAttendant 2.5s infinite;
            background: rgba(0, 0, 170, 0.95);
            border: 8px solid #AAAAFF;
            border-radius: 15px;
            padding: 40px 60px;
            box-shadow: 0 0 40px rgba(170, 170, 255, 0.8);
        }

        .attendant-title {
            font-size: 64px;
            color: #AAAAFF;
            font-weight: bold;
            letter-spacing: 16px;
            text-shadow: 
                0 0 20px rgba(170, 170, 255, 0.8),
                0 0 40px rgba(170, 170, 255, 0.6),
                4px 4px 8px rgba(0,0,0,1);
            margin-bottom: 15px;
        }

        .attendant-subtitle {
            font-size: 32px;
            color: #FFFFFF;
            font-weight: bold;
            letter-spacing: 8px;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,1),
                0 0 10px rgba(255, 255, 255, 0.5);
        }

        @keyframes flashAttendant {
            0%, 24% { 
                opacity: 1;
                border-color: #FF6600;
                box-shadow: 0 0 40px rgba(255, 102, 0, 0.8);
            }
            25%, 49% { 
                opacity: 0;
            }
            50%, 74% { 
                opacity: 1;
                border-color: #FFFF00;
                box-shadow: 0 0 40px rgba(255, 255, 0, 0.8);
            }
            75%, 100% { 
                opacity: 0;
            }
        }

        /* Multi-hand popup styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 170, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .popup-overlay.active {
            display: flex;
        }

        .popup-content {
            background: #0000AA;
            border: 5px solid #FFFF00;
            border-radius: 10px;
            padding: 30px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .popup-title {
            color: #FFFF00;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 4px;
        }

        .hand-select-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .hand-select-button {
            background: #AAAAFF;
            color: #0000AA;
            border: 3px solid #AAAAFF;
            padding: 20px 30px;
            font-size: 24px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            min-width: 100px;
        }

        .hand-select-button:hover {
            background: #FFFF00;
            border-color: #FFFF00;
        }

        .win-results {
            color: #AAAAFF;
            font-size: 14px;
            line-height: 1.6;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .win-line {
            padding: 5px;
            margin: 2px 0;
        }

        .win-line.winner {
            color: #00FF00;
            font-weight: bold;
        }

        .total-win {
            color: #FFFF00;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border: 3px solid #FFFF00;
            background: rgba(255, 255, 0, 0.1);
        }

        .popup-close-button {
            background: #AAAAFF;
            color: #0000AA;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            display: block;
            margin: 20px auto 0;
        }

        .popup-close-button:hover {
            background: #FFFF00;
        }
    </style>
</head>
<body>
    <!-- Fireworks Canvas Overlay for Jackpots -->
    <canvas id="fireworksCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none;"></canvas>

    <!-- Hand Selection Popup for Multi-Hand -->
    <div id="hand-select-popup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-title">SELECT NUMBER OF HANDS</div>
            <div class="hand-select-buttons">
                <button class="hand-select-button" onclick="game && game.selectNumHands(3)">3 HANDS</button>
                <button class="hand-select-button" onclick="game && game.selectNumHands(5)">5 HANDS</button>
                <button class="hand-select-button" onclick="game && game.selectNumHands(10)">10 HANDS</button>
                <button class="hand-select-button" onclick="game && game.selectNumHands(25)">25 HANDS</button>
            </div>
        </div>
    </div>

    <!-- Win Results Popup for Multi-Hand -->
    <div id="win-results-popup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-title">HAND RESULTS</div>
            <div id="win-results-list" class="win-results"></div>
            <div id="total-win-display" class="total-win"></div>
            <button class="popup-close-button" onclick="closeWinPopup()">CONTINUE</button>
        </div>
    </div>

    <div id="game-container">
        <!-- HOME SCREEN -->
        <div id="home-screen">
            <!-- CALL ATTENDANT Overlay - Only shows on home screen when Firebase disconnected -->
            <div id="attendant-overlay">
                <div class="attendant-message">
                    <div class="attendant-title">CALL ATTENDANT</div>
                    <div class="attendant-subtitle">COIN-OUT TIMEOUT</div>
                </div>
            </div>
            <pre class="home-logo">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                           ‚ïë
‚ïë         C A S I N O   V I D E O           ‚ïë
‚ïë               P O K E R                   ‚ïë
‚ïë                                           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            </pre>
            
            <div class="credit-display">
                CREDIT: $<span id="home-cash">-----</span>
            </div>

            <div class="game-menu">
                <button class="game-button" onclick="startGame('jacks')">
                    JACKS OR BETTER
                </button>
                <br>
                <button class="game-button" onclick="startGame('deuces')">
                    DEUCES WILD
                </button>
                <br>
                <button class="game-button" onclick="startGame('baccarat')">
                    BACCARAT
                </button>
                <br>
                <button class="game-button" onclick="startGame('blackjack')">
                    BLACKJACK
                </button>
                <br>
                <button class="game-button" onclick="startGame('threecard')">
                    THREE CARD POKER
                </button>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen">
            <div style="margin-bottom: 15px;">
            </div>

            <div class="game-variant" style="display: none;" id="game-variant"></div>
            
            <div style="text-align: center;">
                <div class="pay-table" id="pay-table"></div>
            </div>

            <div class="result" id="result">Select cards to HOLD</div>

            <div class="cards-area" id="cards-area"></div>

            <pre class="info-bar" id="info-bar"></pre>

            <div class="controls">
                <div id="betting-controls" class="casino-controls">
                    <div style="color: #CC0000; font-size: 28px; font-weight: bold; -webkit-text-stroke: 1px white; text-stroke: 1px white; margin-right: 20px; min-width: 200px;">
                        <span id="game-variant-display">JACKS OR BETTER</span>
                    </div>
                    <button onclick="returnToHome()" class="control-btn">MENU</button>
                    <button onclick="console.log('Options')" class="control-btn">OPTIONS</button>
                    <button onclick="toggleSound()" class="control-btn">üîâ&nbsp;‚ñà‚ñà‚ñà‚ñë‚ñë</button>
                    <div class="bet-display">
                        <div class="bet-label">BET</div>
                        <div class="bet-amount" id="bet-amount">$1</div>
                    </div>
                    <button onclick="betUp()" class="control-btn">BET UP</button>
                    <button onclick="betMax()" class="control-btn">BET MAX</button>
                    <button onclick="game.deal()" class="control-btn control-btn-deal" id="deal-draw-btn">DEAL</button>
                    <div style="color: #CC0000; font-size: 28px; font-weight: bold; -webkit-text-stroke: 1px white; text-stroke: 1px white; margin-left: 20px; min-width: 200px;">
                        CASH $<span id="game-cash-display">1000</span>
                    </div>
                </div>
                <div id="holding-controls" class="casino-controls hidden">
                    <div style="color: #CC0000; font-size: 28px; font-weight: bold; -webkit-text-stroke: 1px white; text-stroke: 1px white; margin-right: 20px; min-width: 200px;">
                        <span id="game-variant-display-hold">JACKS OR BETTER</span>
                    </div>
                    <button onclick="returnToHome()" class="control-btn">MENU</button>
                    <button onclick="console.log('Options')" class="control-btn">OPTIONS</button>
                    <button onclick="toggleSound()" class="control-btn">üîâ&nbsp;‚ñà‚ñà‚ñà‚ñë‚ñë</button>
                    <div class="bet-display">
                        <div class="bet-label">BET</div>
                        <div class="bet-amount" id="bet-amount-hold">$1</div>
                    </div>
                    <button onclick="betUp()" class="control-btn">BET UP</button>
                    <button onclick="betMax()" class="control-btn">BET MAX</button>
                    <button onclick="game.draw()" class="control-btn control-btn-deal" id="action-button">DRAW</button>
                    <div style="color: #CC0000; font-size: 28px; font-weight: bold; -webkit-text-stroke: 1px white; text-stroke: 1px white; margin-left: 20px; min-width: 200px;">
                        CASH $<span id="game-cash-display-hold">1000</span>
                    </div>
                    <!-- Blackjack action buttons (hidden for video poker, shown for blackjack) -->
                    <div id="blackjack-actions" style="display: none; gap: 8px;">
                        <button onclick="game.hit()" class="control-btn" id="hit-button">HIT</button>
                        <button onclick="game.stand()" class="control-btn" id="stand-button-bj">STAND</button>
                        <button onclick="game.doubleDown()" class="control-btn" id="double-button-bj" style="display: none;">DOUBLE</button>
                        <button onclick="game.split()" class="control-btn" id="split-button-bj" style="display: none;">SPLIT</button>
                    </div>
                </div>
                <div id="result-controls" class="casino-controls hidden">
                    <div style="color: #CC0000; font-size: 28px; font-weight: bold; -webkit-text-stroke: 1px white; text-stroke: 1px white; margin-right: 20px; min-width: 200px;">
                        <span id="game-variant-display-result">JACKS OR BETTER</span>
                    </div>
                    <button onclick="returnToHome()" class="control-btn">MENU</button>
                    <button onclick="console.log('Options')" class="control-btn">OPTIONS</button>
                    <button onclick="toggleSound()" class="control-btn">üîâ&nbsp;‚ñà‚ñà‚ñà‚ñë‚ñë</button>
                    <div class="bet-display">
                        <div class="bet-label">BET</div>
                        <div class="bet-amount" id="bet-amount-result">$1</div>
                    </div>
                    <button onclick="betUp()" class="control-btn">BET UP</button>
                    <button onclick="betMax()" class="control-btn">BET MAX</button>
                    <button onclick="game.newGame()" class="control-btn control-btn-deal">DRAW</button>
                    <div style="color: #CC0000; font-size: 28px; font-weight: bold; -webkit-text-stroke: 1px white; text-stroke: 1px white; margin-left: 20px; min-width: 200px;">
                        CASH $<span id="game-cash-display-result">1000</span>
                    </div>
                </div>
                <div style="display: none;" id="key-help">
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUITS = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];

        // Helper function to create decorative card backs
        function createCardBack(width, height) {
            const cardBack = document.createElement("div");
            cardBack.style.cssText = `
                width: ${width}px;
                height: ${height}px;
                background: linear-gradient(135deg, #CC0000 0%, #FF3333 50%, #CC0000 100%);
                border: 3px solid #FFFFFF;
                border-radius: 8px;
                display: flex;
                justify-content: center;
                align-items: center;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                position: relative;
                overflow: hidden;
            `;
            
            const innerBorder = document.createElement("div");
            innerBorder.style.cssText = `
                position: absolute;
                top: 8px;
                left: 8px;
                right: 8px;
                bottom: 8px;
                border: 2px solid rgba(255, 255, 255, 0.6);
                border-radius: 5px;
            `;
            
            const pattern = document.createElement("div");
            pattern.style.cssText = `
                width: 60%;
                height: 60%;
                background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
                border: 2px solid rgba(255, 255, 255, 0.4);
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: ${Math.floor(width / 5)}px;
                color: rgba(255,255,255,0.8);
                font-weight: bold;
            `;
            pattern.textContent = "‚ô† ‚ô• ‚ô¶ ‚ô£";
            
            cardBack.appendChild(innerBorder);
            cardBack.appendChild(pattern);
            
            return cardBack;
        }
        const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const RANK_VALUES = {
            '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, 
            '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14
        };

        const PAY_TABLES = {
            jacks: {
                'Royal Flush': [250, 500, 750, 1000, 4000],
                'Straight Flush': [50, 100, 150, 200, 250],
                'Four of a Kind': [25, 50, 75, 100, 125],
                'Full House': [9, 18, 27, 36, 45],
                'Flush': [6, 12, 18, 24, 30],
                'Straight': [4, 8, 12, 16, 20],
                'Three of a Kind': [3, 6, 9, 12, 15],
                'Two Pair': [2, 4, 6, 8, 10],
                'Jacks or Better': [1, 2, 3, 4, 5]
            },
            deuces: {
                'Natural Royal Flush': [250, 500, 750, 1000, 4000],
                'Four Deuces': [200, 400, 600, 800, 1000],
                'Wild Royal Flush': [25, 50, 75, 100, 125],
                'Five of a Kind': [15, 30, 45, 60, 75],
                'Straight Flush': [9, 18, 27, 36, 45],
                'Four of a Kind': [5, 10, 15, 20, 25],
                'Full House': [3, 6, 9, 12, 15],
                'Flush': [2, 4, 6, 8, 10],
                'Straight': [2, 4, 6, 8, 10],
                'Three of a Kind': [1, 2, 3, 4, 5]
            }
        };

        let globalCash = 1000; // Will be loaded from Firebase on page load
        let currentGameType = null;

        class Card {
            constructor(suit, rank) {
                this.suit = suit;
                this.rank = rank;
                this.value = RANK_VALUES[rank];
            }
        }

        class Deck {
            constructor() {
                this.cards = [];
                this.reset();
            }

            reset() {
                this.cards = [];
                for (let suit of SUITS) {
                    for (let rank of RANKS) {
                        this.cards.push(new Card(suit, rank));
                    }
                }
                this.shuffle();
            }

            shuffle() {
                for (let i = this.cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
                }
            }

            deal(count) {
                return this.cards.splice(0, count);
            }
        }

        const THREE_CARD_PAYTABLE = {
            'Straight Flush': 40,
            'Three of a Kind': 30,
            'Straight': 6,
            'Flush': 3,
            'Pair': 1
        };

        const THREE_CARD_ANTE_BONUS = {
            'Straight Flush': 5,
            'Three of a Kind': 4,
            'Straight': 1
        };

        class BaccaratGame {
            constructor() {
                this.deck = new Deck();
                this.playerHand = [];
                this.bankerHand = [];
                this.bet = 1;
                this.betType = null; // 'player', 'banker', 'tie', 'playerPair', 'bankerPair'
                this.bets = { player: 0, banker: 0, tie: 0, playerPair: 0, bankerPair: 0 };
                this.cash = globalCash;
                this.state = 'betting'; // betting, dealing, result
                this.cardsToAnimate = [];
            }

            placeBet(betType) {
                if (this.state !== 'betting') return;
                if (this.bet > this.cash) {
                    document.getElementById('result').textContent = 'Insufficient Credits!';
                    return;
                }
                
                // Add bet to the selected type
                this.bets[betType] += this.bet;
                this.cash -= this.bet;
                globalCash = this.cash;
                updateHomeCash();
                
                this.updateDisplay();
            }

            clearBets() {
                if (this.state !== 'betting') return;
                
                // Refund all bets
                const totalBets = Object.values(this.bets).reduce((sum, b) => sum + b, 0);
                this.cash += totalBets;
                globalCash = this.cash;
                updateHomeCash();
                
                this.bets = { player: 0, banker: 0, tie: 0, playerPair: 0, bankerPair: 0 };
                this.updateDisplay();
            }

            deal() {
                if (this.state !== 'betting') return;
                
                const totalBets = Object.values(this.bets).reduce((sum, b) => sum + b, 0);
                if (totalBets === 0) {
                    document.getElementById('result').textContent = 'Place a bet first!';
                    return;
                }
                
                // Play card dealing sound
                if (window.casinoSounds) {
                    window.casinoSounds.cardDeal();
                }
                
                this.deck.reset();
                this.playerHand = [];
                this.bankerHand = [];
                
                // Deal initial cards (2 to each)
                this.playerHand.push(this.deck.deal(1)[0]);
                this.bankerHand.push(this.deck.deal(1)[0]);
                this.playerHand.push(this.deck.deal(1)[0]);
                this.bankerHand.push(this.deck.deal(1)[0]);
                
                this.cardsToAnimate = [0, 1, 2, 3];
                this.state = 'dealing';
                
                document.getElementById('betting-controls').classList.add('hidden');
                document.getElementById('result').textContent = '';
                
                this.renderCards();
                
                // Auto-play according to baccarat rules
                setTimeout(() => this.applyBaccaratRules(), 1000);
            }

            applyBaccaratRules() {
                const playerTotal = this.getHandValue(this.playerHand);
                const bankerTotal = this.getHandValue(this.bankerHand);
                
                // Natural win (8 or 9)
                if (playerTotal >= 8 || bankerTotal >= 8) {
                    this.determineWinner();
                    return;
                }
                
                // Player draws third card if 0-5
                if (playerTotal <= 5) {
                    const card = this.deck.deal(1)[0];
                    this.playerHand.push(card);
                    this.cardsToAnimate = [this.playerHand.length - 1];
                    this.renderCards();
                    
                    setTimeout(() => this.bankerDrawLogic(), 500);
                } else {
                    this.bankerDrawLogic();
                }
            }

            bankerDrawLogic() {
                const bankerTotal = this.getHandValue(this.bankerHand);
                const playerThirdCard = this.playerHand[2] ? this.playerHand[2].value % 10 : null;
                
                let bankerDraws = false;
                
                if (this.playerHand.length === 2) {
                    // Player stood, banker draws on 0-5
                    bankerDraws = bankerTotal <= 5;
                } else {
                    // Complex banker drawing rules based on player's third card
                    if (bankerTotal <= 2) bankerDraws = true;
                    else if (bankerTotal === 3) bankerDraws = playerThirdCard !== 8;
                    else if (bankerTotal === 4) bankerDraws = [2,3,4,5,6,7].includes(playerThirdCard);
                    else if (bankerTotal === 5) bankerDraws = [4,5,6,7].includes(playerThirdCard);
                    else if (bankerTotal === 6) bankerDraws = [6,7].includes(playerThirdCard);
                }
                
                if (bankerDraws) {
                    const card = this.deck.deal(1)[0];
                    this.bankerHand.push(card);
                    this.cardsToAnimate = [100 + this.bankerHand.length - 1];
                    this.renderCards();
                    setTimeout(() => this.determineWinner(), 500);
                } else {
                    this.determineWinner();
                }
            }

            determineWinner() {
                const playerTotal = this.getHandValue(this.playerHand);
                const bankerTotal = this.getHandValue(this.bankerHand);
                
                // Check for pairs
                const playerPair = this.playerHand.length >= 2 && 
                    this.playerHand[0].rank === this.playerHand[1].rank;
                const bankerPair = this.bankerHand.length >= 2 && 
                    this.bankerHand[0].rank === this.bankerHand[1].rank;
                
                let totalWin = 0;
                let message = '';
                
                // Evaluate bets
                if (playerTotal > bankerTotal) {
                    message = `Player ${playerTotal} - Banker ${bankerTotal} | PLAYER WINS!`;
                    totalWin += this.bets.player * 2; // 1:1 payout
                } else if (bankerTotal > playerTotal) {
                    message = `Player ${playerTotal} - Banker ${bankerTotal} | BANKER WINS!`;
                    totalWin += this.bets.banker * 2; // 1:1 payout
                } else {
                    message = `Player ${playerTotal} - Banker ${bankerTotal} | TIE!`;
                    totalWin += this.bets.tie * 9; // 8:1 payout
                    totalWin += this.bets.player; // Return player bet
                    totalWin += this.bets.banker; // Return banker bet
                }
                
                // Pair bonuses
                if (playerPair) {
                    totalWin += this.bets.playerPair * 12; // 11:1 payout
                    message += ' +Player Pair!';
                }
                if (bankerPair) {
                    totalWin += this.bets.bankerPair * 12; // 11:1 payout
                    message += ' +Banker Pair!';
                }
                
                this.cash += totalWin;
                globalCash = this.cash;
                updateHomeCash();
                
                // Play appropriate sound
                if (window.casinoSounds) {
                    if (totalWin > 0) {
                        const netWin = totalWin - Object.values(this.bets).reduce((sum, b) => sum + b, 0);
                        if (netWin > 0) {
                            window.casinoSounds.smallWin();
                        }
                    } else {
                        window.casinoSounds.lose();
                    }
                }
                
                this.state = 'result';
                document.getElementById('result-controls').classList.remove('hidden');
                document.getElementById('result').textContent = message;
                
                this.updateDisplay();
            }

            getHandValue(hand) {
                let total = 0;
                for (let card of hand) {
                    let value = card.value;
                    if (value > 10) value = 0; // Face cards = 0
                    else if (value === 10) value = 0; // 10 = 0
                    else value = value; // Ace = 1, 2-9 = face value
                    total += value;
                }
                return total % 10; // Baccarat uses modulo 10
            }

            newGame() {
                if (this.cash >= 1) {
                    this.state = 'betting';
                    this.bets = { player: 0, banker: 0, tie: 0, playerPair: 0, bankerPair: 0 };
                    
                    this.renderCardBacks();
                    
                    document.getElementById('result-controls').classList.add('hidden');
                    document.getElementById('betting-controls').classList.remove('hidden');
                    document.getElementById('result').innerHTML = 'Place your bets';
                    
                    this.updateDisplay();
                } else {
                    document.getElementById('result').textContent = 'GAME OVER - No Credits!';
                }
            }

            renderCardBacks() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.justifyContent = 'center';
                cardsArea.style.alignItems = 'center';
                cardsArea.style.gap = '60px';
                
                // Player section with card backs
                const playerSection = document.createElement('div');
                playerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const playerLabel = document.createElement('div');
                playerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                playerLabel.textContent = 'PLAYER';
                playerSection.appendChild(playerLabel);
                
                const playerRow = document.createElement('div');
                playerRow.style.cssText = 'display: flex; gap: 8px;';
                playerRow.appendChild(createCardBack(280, 400));
                playerRow.appendChild(createCardBack(280, 400));
                playerSection.appendChild(playerRow);
                
                cardsArea.appendChild(playerSection);
                
                // Banker section with card backs
                const bankerSection = document.createElement('div');
                bankerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const bankerLabel = document.createElement('div');
                bankerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                bankerLabel.textContent = 'BANKER';
                bankerSection.appendChild(bankerLabel);
                
                const bankerRow = document.createElement('div');
                bankerRow.style.cssText = 'display: flex; gap: 8px;';
                bankerRow.appendChild(createCardBack(280, 400));
                bankerRow.appendChild(createCardBack(280, 400));
                bankerSection.appendChild(bankerRow);
                
                cardsArea.appendChild(bankerSection);
            }

            updateDisplay() {
                // Show bet amounts
                const payTable = document.getElementById('pay-table');
                if (payTable) {
                    payTable.style.display = 'inline-block';
                }
                
                let payTableHTML = '';
                payTableHTML += 'Bet Type              Payout    Your Bet\n';
                payTableHTML += '=============================================\n';
                payTableHTML += `Player Wins           1:1       $${this.bets.player}\n`;
                payTableHTML += `Banker Wins           1:1       $${this.bets.banker}\n`;
                payTableHTML += `Tie                   8:1       $${this.bets.tie}\n`;
                payTableHTML += `Player Pair          11:1       $${this.bets.playerPair}\n`;
                payTableHTML += `Banker Pair          11:1       $${this.bets.bankerPair}\n`;
                
                document.getElementById('pay-table').innerHTML = payTableHTML;
                document.getElementById('info-bar').innerHTML = '';
                
                const cashDisplays = ['game-cash-display', 'game-cash-display-hold', 'game-cash-display-result'];
                cashDisplays.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.textContent = this.cash;
                });
            }

            renderCards() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.justifyContent = 'center';
                cardsArea.style.alignItems = 'center';
                cardsArea.style.gap = '60px';
                
                const cardWidth = 280;
                const cardHeight = 400;
                const fontSize = 96;
                
                // Player section
                const playerSection = document.createElement('div');
                playerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const playerLabel = document.createElement('div');
                playerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                playerLabel.textContent = 'PLAYER';
                playerSection.appendChild(playerLabel);
                
                const playerRow = document.createElement('div');
                playerRow.style.cssText = 'display: flex; gap: 8px;';
                
                this.playerHand.forEach((card, i) => {
                    const container = this.createCardElement(card, i, false, cardWidth, cardHeight, fontSize);
                    playerRow.appendChild(container);
                });
                playerSection.appendChild(playerRow);
                
                const playerTotal = document.createElement('div');
                playerTotal.style.cssText = 'text-align: center; color: #FFFF00; font-size: 48px; font-weight: bold; margin-top: 10px;';
                playerTotal.textContent = this.getHandValue(this.playerHand);
                playerSection.appendChild(playerTotal);
                
                cardsArea.appendChild(playerSection);
                
                // Banker section
                const bankerSection = document.createElement('div');
                bankerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const bankerLabel = document.createElement('div');
                bankerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                bankerLabel.textContent = 'BANKER';
                bankerSection.appendChild(bankerLabel);
                
                const bankerRow = document.createElement('div');
                bankerRow.style.cssText = 'display: flex; gap: 8px;';
                
                this.bankerHand.forEach((card, i) => {
                    const container = this.createCardElement(card, i + 100, false, cardWidth, cardHeight, fontSize);
                    bankerRow.appendChild(container);
                });
                bankerSection.appendChild(bankerRow);
                
                const bankerTotal = document.createElement('div');
                bankerTotal.style.cssText = 'text-align: center; color: #FFFF00; font-size: 48px; font-weight: bold; margin-top: 10px;';
                bankerTotal.textContent = this.getHandValue(this.bankerHand);
                bankerSection.appendChild(bankerTotal);
                
                cardsArea.appendChild(bankerSection);
                
                this.cardsToAnimate = [];
            }

            createCardElement(card, index, faceDown, width = 280, height = 400, centerFontSize = 96) {
                const container = document.createElement('div');
                container.style.cssText = 'text-align: center; position: relative;';
                
                const cardDiv = document.createElement('div');
                const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                
                const shouldAnimate = this.cardsToAnimate.includes(index);
                if (shouldAnimate) {
                    cardDiv.className = 'card-dealing';
                    cardDiv.style.animationDelay = `${(index % 100) * 0.15}s`;
                }
                
                const topFontSize = Math.floor(width * 0.21);
                const topSuitSize = Math.floor(width * 0.16);
                const bottomFontSize = Math.floor(width * 0.086);
                const bottomSuitSize = Math.floor(width * 0.071);
                
                cardDiv.style.cssText = `
                    width: ${width}px;
                    height: ${height}px;
                    background: #FFFFFF;
                    border: 3px solid #333;
                    border-radius: 8px;
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                    padding: 8px 6px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    overflow: hidden;
                    ${shouldAnimate ? `animation-delay: ${(index % 100) * 0.15}s;` : ''}
                `;
                
                const topCorner = document.createElement('div');
                topCorner.style.cssText = `
                    text-align: left;
                    line-height: 1;
                    color: ${isRed ? '#DD0000' : '#000000'};
                `;
                topCorner.innerHTML = `
                    <div style="font-size: ${topFontSize}px; font-weight: bold;">${card.rank}</div>
                    <div style="font-size: ${topSuitSize}px;">${card.suit}</div>
                `;
                
                const centerSuit = document.createElement('div');
                centerSuit.style.cssText = `
                    text-align: center;
                    font-size: ${centerFontSize}px;
                    color: ${isRed ? '#DD0000' : '#000000'};
                `;
                centerSuit.textContent = card.suit;
                
                const bottomCorner = document.createElement('div');
                bottomCorner.style.cssText = `
                    text-align: right;
                    line-height: 1;
                    transform: rotate(180deg);
                    color: ${isRed ? '#DD0000' : '#000000'};
                `;
                bottomCorner.innerHTML = `
                    <div style="font-size: ${bottomFontSize}px; font-weight: bold;">${card.rank}</div>
                    <div style="font-size: ${bottomSuitSize}px;">${card.suit}</div>
                `;
                
                cardDiv.appendChild(topCorner);
                cardDiv.appendChild(centerSuit);
                cardDiv.appendChild(bottomCorner);
                
                container.appendChild(cardDiv);
                return container;
            }

            setBet(amount) {
                if (this.state !== 'betting') return;
                if (amount > this.cash) {
                    document.getElementById('result').textContent = 'Insufficient Credits!';
                    return;
                }
                this.bet = amount;
                this.updateDisplay();
            }

            draw() {
                // Not used in Baccarat
            }
        }

        class ThreeCardPokerGame {
            constructor() {
                this.deck = new Deck();
                this.playerHand = [];
                this.dealerHand = [];
                this.bet = 1;
                this.cash = globalCash;
                this.state = 'betting'; // betting, playing, result
                this.cardsToAnimate = [];
                this.dealerRevealed = false;
                this.winningHand = null;
            }

            setBet(amount) {
                if (this.state !== 'betting') return;
                if (amount > this.cash) {
                    document.getElementById('result').textContent = 'Insufficient Credits!';
                    return;
                }
                this.bet = amount;
                
                this.updateDisplay();
            }

            deal() {
                if (this.state !== 'betting' || this.bet > this.cash) return;
                
                // Ante bet
                this.cash -= this.bet;
                globalCash = this.cash;
                updateHomeCash();
                
                this.deck.reset();
                this.playerHand = this.deck.deal(3);
                this.dealerHand = this.deck.deal(3);
                this.dealerRevealed = false;
                
                this.cardsToAnimate = [0, 1, 2];
                this.state = 'playing';
                
                document.getElementById('betting-controls').classList.add('hidden');
                document.getElementById('holding-controls').classList.remove('hidden');
                document.getElementById('result').textContent = 'PLAY or FOLD?';
                
                this.renderCards();
                this.updateDisplay();
            }

            play() {
                if (this.state !== 'playing') return;
                
                // Play bet (equal to ante)
                this.cash -= this.bet;
                globalCash = this.cash;
                updateHomeCash();
                
                this.state = 'result';
                this.dealerRevealed = true;
                this.renderCards();
                
                setTimeout(() => this.determineWinner(), 500);
            }

            fold() {
                if (this.state !== 'playing') return;
                
                this.state = 'result';
                document.getElementById('holding-controls').classList.add('hidden');
                document.getElementById('result-controls').classList.remove('hidden');
                document.getElementById('result').textContent = 'FOLDED - Dealer Wins';
                
                this.updateDisplay();
            }

            determineWinner() {
                const playerHandType = this.getHandType(this.playerHand);
                const dealerHandType = this.getHandType(this.dealerHand);
                
                // Check if dealer qualifies (Queen high or better)
                const dealerQualifies = this.dealerQualifies();
                
                let winAmount = 0;
                let message = '';
                let winningHand = null;
                
                // Ante bonus (paid regardless of dealer)
                if (THREE_CARD_ANTE_BONUS[playerHandType]) {
                    winAmount += this.bet * THREE_CARD_ANTE_BONUS[playerHandType];
                    message = `${playerHandType} - Ante Bonus! `;
                    winningHand = playerHandType;
                }
                
                if (!dealerQualifies) {
                    // Dealer doesn't qualify - ante pays 1:1, play is push
                    winAmount += this.bet * 2; // Return ante + win
                    message += 'Dealer No Qualify! ';
                } else {
                    // Compare hands
                    const playerRank = this.getHandRank(this.playerHand, playerHandType);
                    const dealerRank = this.getHandRank(this.dealerHand, dealerHandType);
                    
                    if (playerRank > dealerRank) {
                        winAmount += this.bet * 4; // Ante + Play both pay 1:1
                        message += `You WIN $${winAmount}!`;
                        if (!winningHand && THREE_CARD_PAYTABLE[playerHandType]) {
                            winningHand = playerHandType;
                        }
                    } else if (dealerRank > playerRank) {
                        message += 'Dealer Wins';
                    } else {
                        winAmount += this.bet * 2; // Push - return bets
                        message += 'PUSH - Tie!';
                    }
                }
                
                this.cash += winAmount;
                globalCash = this.cash;
                updateHomeCash();
                this.winningHand = winningHand;
                
                // Track stats
                if (window.stats && window.stats.gameResult) {
                    window.stats.gameResult('threecard', this.bet * 2, message, winAmount, this.playerHand, this.dealerHand);
                }
                if (window.stats && window.stats.handPlayed && winningHand) {
                    window.stats.handPlayed('threecard', winningHand, this.bet, winAmount);
                }
                
                document.getElementById('holding-controls').classList.add('hidden');
                document.getElementById('result-controls').classList.remove('hidden');
                document.getElementById('result').textContent = message;
                
                this.updateDisplay();
            }

            dealerQualifies() {
                const values = this.dealerHand.map(c => c.value).sort((a, b) => b - a);
                return values[0] >= 12; // Queen or higher
            }

            getHandType(hand) {
                const ranks = hand.map(c => c.rank);
                const suits = hand.map(c => c.suit);
                const values = hand.map(c => c.value).sort((a, b) => a - b);
                
                const isFlush = suits.every(s => s === suits[0]);
                const isStraight = (values[2] - values[0] === 2 && values[1] - values[0] === 1) || 
                                   (values[0] === 2 && values[1] === 3 && values[2] === 14); // A-2-3
                
                // Count ranks
                const rankCounts = {};
                for (let rank of ranks) {
                    rankCounts[rank] = (rankCounts[rank] || 0) + 1;
                }
                const counts = Object.values(rankCounts).sort((a, b) => b - a);
                
                if (isFlush && isStraight) return 'Straight Flush';
                if (counts[0] === 3) return 'Three of a Kind';
                if (isStraight) return 'Straight';
                if (isFlush) return 'Flush';
                if (counts[0] === 2) return 'Pair';
                
                return 'High Card';
            }

            getHandRank(hand, handType) {
                const typeRanks = {
                    'Straight Flush': 9,
                    'Three of a Kind': 8,
                    'Straight': 7,
                    'Flush': 6,
                    'Pair': 5,
                    'High Card': 4
                };
                
                const values = hand.map(c => c.value).sort((a, b) => b - a);
                let rank = typeRanks[handType] * 100000;
                
                // Add high card tiebreakers
                rank += values[0] * 1000 + values[1] * 10 + values[2];
                
                return rank;
            }

            newGame() {
                if (this.cash >= 1) {
                    this.state = 'betting';
                    this.bet = Math.min(this.bet, this.cash);
                    this.winningHand = null;
                    
                    // Show card backs instead of clearing
                    this.renderCardBacks();
                    
                    document.getElementById('result-controls').classList.add('hidden');
                    document.getElementById('betting-controls').classList.remove('hidden');
                    document.getElementById('result').innerHTML = '&nbsp;';
                    
                    this.updateDisplay();
                } else {
                    document.getElementById('result').textContent = 'GAME OVER - No Credits!';
                }
            }

            renderCardBacks() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.justifyContent = 'center';
                cardsArea.style.alignItems = 'center';
                cardsArea.style.gap = '60px';
                
                // Dealer section with 3 card backs
                const dealerSection = document.createElement('div');
                dealerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const dealerLabel = document.createElement('div');
                dealerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 18px; font-weight: bold; margin-bottom: 10px;';
                dealerLabel.textContent = 'DEALER';
                dealerSection.appendChild(dealerLabel);
                
                const dealerRow = document.createElement('div');
                dealerRow.style.cssText = 'display: flex; gap: 8px;';
                for (let i = 0; i < 3; i++) {
                    dealerRow.appendChild(createCardBack(280, 400));
                }
                dealerSection.appendChild(dealerRow);
                
                cardsArea.appendChild(dealerSection);
                
                // Player section with 3 card backs
                const playerSection = document.createElement('div');
                playerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const playerLabel = document.createElement('div');
                playerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 18px; font-weight: bold; margin-bottom: 10px;';
                playerLabel.textContent = 'PLAYER';
                playerSection.appendChild(playerLabel);
                
                const playerRow = document.createElement('div');
                playerRow.style.cssText = 'display: flex; gap: 8px;';
                for (let i = 0; i < 3; i++) {
                    playerRow.appendChild(createCardBack(280, 400));
                }
                playerSection.appendChild(playerRow);
                
                cardsArea.appendChild(playerSection);
            }

            updateDisplay() {
                // Make sure pay table is visible
                const payTable = document.getElementById('pay-table');
                if (payTable) {
                    payTable.style.display = 'inline-block';
                }
                
                let payTableHTML = '';
                const hands = [
                    { name: 'Straight Flush', payout: '40:1', ante: '5:1' },
                    { name: 'Three of a Kind', payout: '30:1', ante: '4:1' },
                    { name: 'Straight', payout: '6:1', ante: '1:1' },
                    { name: 'Flush', payout: '3:1', ante: '-' },
                    { name: 'Pair', payout: '1:1', ante: '-' }
                ];
                
                payTableHTML += 'Hand                  Payout   Ante Bonus\n';
                payTableHTML += '===============================================\n';
                
                hands.forEach(hand => {
                    const isWinning = this.winningHand === hand.name;
                    const line = `${hand.name.padEnd(25)}${hand.payout.padStart(4)}    ${hand.ante.padStart(4)}\n`;
                    
                    if (isWinning) {
                        payTableHTML += `<span class="highlight">${line}</span>`;
                    } else {
                        payTableHTML += line;
                    }
                });
                
                document.getElementById('pay-table').innerHTML = payTableHTML;

                document.getElementById('info-bar').innerHTML = '';
                
                // Update cash displays
                const cashDisplays = ['game-cash-display', 'game-cash-display-hold', 'game-cash-display-result'];
                cashDisplays.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.textContent = this.cash;
                });
            }

            renderCards() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.opacity = '1';
                cardsArea.style.transition = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.justifyContent = 'center';
                cardsArea.style.alignItems = 'center';
                cardsArea.style.gap = '60px';
                
                // Dealer's section
                const dealerSection = document.createElement('div');
                dealerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const dealerLabel = document.createElement('div');
                dealerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 18px; font-weight: bold; margin-bottom: 10px;';
                dealerLabel.textContent = 'DEALER';
                dealerSection.appendChild(dealerLabel);
                
                const dealerRow = document.createElement('div');
                dealerRow.style.cssText = 'display: flex; gap: 8px;';
                
                this.dealerHand.forEach((card, i) => {
                    const container = this.createCardElement(card, i + 100, !this.dealerRevealed);
                    dealerRow.appendChild(container);
                });
                dealerSection.appendChild(dealerRow);
                cardsArea.appendChild(dealerSection);
                
                // Player's section
                const playerSection = document.createElement('div');
                playerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const playerLabel = document.createElement('div');
                playerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 18px; font-weight: bold; margin-bottom: 10px;';
                playerLabel.textContent = 'PLAYER';
                playerSection.appendChild(playerLabel);
                
                const playerRow = document.createElement('div');
                playerRow.style.cssText = 'display: flex; gap: 8px;';
                
                this.playerHand.forEach((card, i) => {
                    const container = this.createCardElement(card, i, false);
                    playerRow.appendChild(container);
                });
                playerSection.appendChild(playerRow);
                cardsArea.appendChild(playerSection);
                
                this.cardsToAnimate = [];
            }

            createCardElement(card, index, faceDown) {
                const container = document.createElement('div');
                container.style.cssText = 'text-align: center; position: relative;';
                
                const cardDiv = document.createElement('div');
                const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                
                const shouldAnimate = this.cardsToAnimate.includes(index);
                if (shouldAnimate) {
                    cardDiv.className = 'card-dealing';
                }
                
                if (faceDown) {
                    cardDiv.style.cssText = `
                        width: 120px;
                        height: 170px;
                        background: #0000AA;
                        border: 3px solid #AAAAFF;
                        border-radius: 8px;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                        ${shouldAnimate ? `animation-delay: ${(index % 100) * 0.1}s;` : ''}
                    `;
                    cardDiv.innerHTML = '<div style="color: #AAAAFF; font-size: 40px;">?</div>';
                } else {
                    cardDiv.style.cssText = `
                        width: 120px;
                        height: 170px;
                        background: #FFFFFF;
                        border: 3px solid #333;
                        border-radius: 8px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        padding: 8px 6px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                        overflow: hidden;
                        ${shouldAnimate ? `animation-delay: ${(index % 100) * 0.1}s;` : ''}
                    `;
                    
                    const topCorner = document.createElement('div');
                    topCorner.style.cssText = `
                        text-align: left;
                        line-height: 1;
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    topCorner.innerHTML = `
                        <div style="font-size: 24px; font-weight: bold;">${card.rank}</div>
                        <div style="font-size: 20px;">${card.suit}</div>
                    `;
                    
                    const centerSuit = document.createElement('div');
                    centerSuit.style.cssText = `
                        text-align: center;
                        font-size: 48px;
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    centerSuit.textContent = card.suit;
                    
                    const bottomCorner = document.createElement('div');
                    bottomCorner.style.cssText = `
                        text-align: right;
                        line-height: 1;
                        transform: rotate(180deg);
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    bottomCorner.innerHTML = `
                        <div style="font-size: 24px; font-weight: bold;">${card.rank}</div>
                        <div style="font-size: 20px;">${card.suit}</div>
                    `;
                    
                    cardDiv.appendChild(topCorner);
                    cardDiv.appendChild(centerSuit);
                    cardDiv.appendChild(bottomCorner);
                }
                
                container.appendChild(cardDiv);
                return container;
            }

            draw() {
                this.play();
            }
        }

        class BlackjackGame {
            constructor() {
                this.deck = new Deck();
                this.playerHand = [];
                this.dealerHand = [];
                this.bet = 1;
                this.originalBet = 1;
                this.cash = globalCash;
                this.state = 'betting'; // betting, playing, dealer, result
                this.cardsToAnimate = [];
                this.dealerRevealed = false;
                this.hasDoubled = false;
                this.canSplit = false;
                this.canDouble = false;
                this.isSplit = false;
                this.splitHands = [];
                this.currentHandIndex = 0;
                this.splitBets = [];
            }

            setBet(amount) {
                if (this.state !== 'betting') return;
                if (amount > this.cash) {
                    document.getElementById('result').textContent = 'Insufficient Credits!';
                    return;
                }
                this.bet = amount;
                
                this.originalBet = amount; // Update originalBet too
                this.updateDisplay();
            }

            deal() {
                if (this.state !== 'betting' || this.bet > this.cash) return;
                
                this.cash -= this.bet;
                this.originalBet = this.bet; // Save the original bet
                globalCash = this.cash;
                updateHomeCash();
                
                this.deck.reset();
                this.playerHand = [];
                this.dealerHand = [];
                this.dealerRevealed = false;
                
                // Deal initial cards
                this.playerHand.push(this.deck.deal(1)[0]);
                this.dealerHand.push(this.deck.deal(1)[0]);
                this.playerHand.push(this.deck.deal(1)[0]);
                this.dealerHand.push(this.deck.deal(1)[0]);
                
                // Play card dealing sound
                if (window.casinoSounds) {
                    window.casinoSounds.cardDeal();
                }
                
                this.cardsToAnimate = [0, 1, 2, 3];
                this.state = 'playing';
                this.hasDoubled = false;
                
                // Check for split and double down eligibility
                this.canSplit = this.playerHand[0].rank === this.playerHand[1].rank && this.cash >= this.bet;
                this.canDouble = this.cash >= this.bet;
                
                // Show/hide buttons
                document.getElementById('betting-controls').classList.add('hidden');
                document.getElementById('holding-controls').classList.remove('hidden');
                document.getElementById('action-button').classList.remove('hidden'); // Show HIT button
                document.getElementById('stand-button')?.classList.remove('hidden'); // Show STAND button
                document.getElementById('result').innerHTML = '&nbsp;';
                
                if (this.canSplit) {
                    document.getElementById('split-button')?.classList.remove('hidden');
                } else {
                    document.getElementById('split-button')?.classList.add('hidden');
                }
                
                if (this.canDouble) {
                    document.getElementById('double-button')?.classList.remove('hidden');
                } else {
                    document.getElementById('double-button')?.classList.add('hidden');
                }
                
                this.renderCards();
                this.updateDisplay();
                
                // Check for blackjack
                if (this.getHandValue(this.playerHand) === 21) {
                    this.stand();
                }
            }

            hit() {
                if (this.state !== 'playing') return;
                
                // Can't split or double after hitting
                this.canSplit = false;
                this.canDouble = false;
                document.getElementById('split-button')?.classList.add('hidden');
                document.getElementById('double-button')?.classList.add('hidden');
                
                this.playerHand.push(this.deck.deal(1)[0]);
                this.cardsToAnimate = [this.playerHand.length - 1];
                
                // Update the split hand if we're playing split hands
                if (this.isSplit) {
                    this.splitHands[this.currentHandIndex] = this.playerHand;
                }
                
                this.renderCards();
                
                const playerValue = this.getHandValue(this.playerHand);
                if (playerValue > 21) {
                    // Player busted - lose sound
                    if (window.casinoSounds) {
                        window.casinoSounds.lose();
                    }
                    if (this.isSplit && this.currentHandIndex === 0) {
                        // First hand busted, move to second hand
                        this.moveToNextSplitHand();
                    } else {
                        this.endGame('BUST! Dealer Wins');
                    }
                } else if (playerValue === 21) {
                    this.stand();
                }
            }

            stand() {
                if (this.state !== 'playing') return;
                
                // Update the split hand if we're playing split hands
                if (this.isSplit) {
                    this.splitHands[this.currentHandIndex] = this.playerHand;
                }
                
                // Hide split and double buttons once action is taken
                document.getElementById('split-button')?.classList.add('hidden');
                document.getElementById('double-button')?.classList.add('hidden');
                
                // If we have split hands and this is the first hand, move to second hand
                if (this.isSplit && this.currentHandIndex === 0) {
                    this.moveToNextSplitHand();
                } else {
                    // Otherwise proceed to dealer play
                    this.state = 'dealer';
                    this.dealerRevealed = true;
                    this.renderCards();
                    
                    // Dealer draws to 17
                    setTimeout(() => this.dealerPlay(), 1000);
                }
            }

            doubleDown() {
                if (this.state !== 'playing' || !this.canDouble) return;
                
                // Double the bet
                this.cash -= this.bet;
                this.bet *= 2;
                globalCash = this.cash;
                updateHomeCash();
                this.hasDoubled = true;
                this.canDouble = false;
                this.canSplit = false;
                
                // Track special action
                if (window.stats && window.stats.specialAction) {
                    window.stats.specialAction('blackjack', 'double', this.bet);
                }
                
                // Hide buttons
                document.getElementById('split-button')?.classList.add('hidden');
                document.getElementById('double-button')?.classList.add('hidden');
                
                // Take one card and automatically stand
                this.playerHand.push(this.deck.deal(1)[0]);
                this.cardsToAnimate = [this.playerHand.length - 1];
                this.renderCards();
                this.updateDisplay();
                
                const playerValue = this.getHandValue(this.playerHand);
                if (playerValue > 21) {
                    // Player busted - lose sound
                    if (window.casinoSounds) {
                        window.casinoSounds.lose();
                    }
                    this.endGame('BUST! Dealer Wins');
                } else {
                    setTimeout(() => this.stand(), 500);
                }
            }

            moveToNextSplitHand() {
                this.currentHandIndex = 1;
                this.playerHand = this.splitHands[1];
                this.bet = this.splitBets[1];
                this.cardsToAnimate = [];
                document.getElementById('result').textContent = 'Hand 2 of 2';
                this.renderCards();
                this.updateDisplay();
            }

            split() {
                if (this.state !== 'playing' || !this.canSplit) return;
                
                // Track special action
                if (window.stats && window.stats.specialAction) {
                    window.stats.specialAction('blackjack', 'split', this.bet);
                }
                
                // Deduct the bet for the second hand
                this.cash -= this.bet;
                globalCash = this.cash;
                updateHomeCash();
                
                // Split the cards into two hands
                this.isSplit = true;
                this.splitHands = [
                    [this.playerHand[0]],
                    [this.playerHand[1]]
                ];
                this.splitBets = [this.bet, this.bet];
                this.currentHandIndex = 0;
                
                // Deal a card to each hand
                this.splitHands[0].push(this.deck.deal(1)[0]);
                this.splitHands[1].push(this.deck.deal(1)[0]);
                
                // Set current hand to first split hand
                this.playerHand = this.splitHands[0];
                
                // Can't split or double after splitting
                this.canSplit = false;
                this.canDouble = false;
                document.getElementById('split-button')?.classList.add('hidden');
                document.getElementById('double-button')?.classList.add('hidden');
                
                this.cardsToAnimate = [1];
                document.getElementById('result').textContent = 'Hand 1 of 2';
                this.renderCards();
                this.updateDisplay();
            }

            dealerPlay() {
                let dealerValue = this.getHandValue(this.dealerHand);
                
                if (dealerValue < 17) {
                    this.dealerHand.push(this.deck.deal(1)[0]);
                    this.cardsToAnimate = [this.dealerHand.length - 1 + 100]; // 100+ for dealer cards
                    this.renderCards();
                    setTimeout(() => this.dealerPlay(), 1000);
                } else {
                    this.determineWinner();
                }
            }

            determineWinner() {
                if (!this.isSplit) {
                    // Normal single hand
                    const playerValue = this.getHandValue(this.playerHand);
                    const dealerValue = this.getHandValue(this.dealerHand);
                    
                    // Check for natural blackjack (21 with first 2 cards)
                    const playerBlackjack = playerValue === 21 && this.playerHand.length === 2;
                    const dealerBlackjack = dealerValue === 21 && this.dealerHand.length === 2;
                    
                    if (playerBlackjack && dealerBlackjack) {
                        // Both have blackjack - push
                        this.endGame(`PUSH - Both Blackjack!`, this.bet);
                    } else if (playerBlackjack) {
                        // Player natural blackjack pays 3:2 - BIG WIN SOUND!
                        const blackjackPayout = Math.floor(this.bet * 2.5);
                        if (window.casinoSounds) {
                            window.casinoSounds.bigWin();
                        }
                        this.endGame(`BLACKJACK! You WIN $${blackjackPayout}!`, blackjackPayout);
                    } else if (dealerBlackjack) {
                        // Dealer has blackjack - lose sound
                        if (window.casinoSounds) {
                            window.casinoSounds.lose();
                        }
                        this.endGame('Dealer Blackjack - Dealer Wins');
                    } else if (dealerValue > 21) {
                        // Player wins - small win sound
                        if (window.casinoSounds) {
                            window.casinoSounds.smallWin();
                        }
                        this.endGame(`Dealer BUSTS! You WIN $${this.bet * 2}`, this.bet * 2);
                    } else if (playerValue > dealerValue) {
                        // Player wins - small win sound
                        if (window.casinoSounds) {
                            window.casinoSounds.smallWin();
                        }
                        this.endGame(`You WIN $${this.bet * 2}!`, this.bet * 2);
                    } else if (dealerValue > playerValue) {
                        // Dealer wins - lose sound
                        if (window.casinoSounds) {
                            window.casinoSounds.lose();
                        }
                        this.endGame('Dealer Wins');
                    } else {
                        // Push - no sound
                        this.endGame(`PUSH - Tie!`, this.bet);
                    }
                } else {
                    // Split hands - evaluate both
                    const dealerValue = this.getHandValue(this.dealerHand);
                    let totalWin = 0;
                    let results = [];
                    
                    for (let i = 0; i < 2; i++) {
                        const handValue = this.getHandValue(this.splitHands[i]);
                        const bet = this.splitBets[i];
                        
                        if (handValue > 21) {
                            results.push(`Hand ${i+1}: BUST`);
                        } else if (dealerValue > 21) {
                            totalWin += bet * 2;
                            results.push(`Hand ${i+1}: WIN $${bet * 2}`);
                        } else if (handValue > dealerValue) {
                            totalWin += bet * 2;
                            results.push(`Hand ${i+1}: WIN $${bet * 2}`);
                        } else if (dealerValue > handValue) {
                            results.push(`Hand ${i+1}: LOSE`);
                        } else {
                            totalWin += bet;
                            results.push(`Hand ${i+1}: PUSH`);
                        }
                    }
                    
                    const message = results.join(' | ') + ` | Total: $${totalWin}`;
                    this.endGame(message, totalWin);
                }
            }

            endGame(message, winAmount = 0) {
                this.state = 'result';
                this.cash += winAmount;
                globalCash = this.cash;
                updateHomeCash();
                
                // Track stats
                if (window.stats && window.stats.gameResult) {
                    const bet = this.isSplit ? (this.splitBets[0] + this.splitBets[1]) : this.bet;
                    window.stats.gameResult('blackjack', bet, message, winAmount, this.playerHand, this.dealerHand);
                }
                
                document.getElementById('holding-controls').classList.add('hidden');
                document.getElementById('result-controls').classList.remove('hidden');
                document.getElementById('result').textContent = message;
                
                this.updateDisplay();
            }

            getHandValue(hand) {
                let value = 0;
                let aces = 0;
                
                for (let card of hand) {
                    if (card.rank === 'A') {
                        aces++;
                        value += 11;
                    } else if (['K', 'Q', 'J'].includes(card.rank)) {
                        value += 10;
                    } else {
                        value += parseInt(card.rank);
                    }
                }
                
                // Adjust for aces
                while (value > 21 && aces > 0) {
                    value -= 10;
                    aces--;
                }
                
                return value;
            }

            newGame() {
                if (this.cash >= 1) {
                    this.state = 'betting';
                    this.bet = Math.min(this.originalBet, this.cash); // Reset to original bet
                    this.isSplit = false; // Reset split
                    this.splitHands = [];
                    this.currentHandIndex = 0;
                    this.splitBets = [];
                    
                    // Show card backs instead of clearing
                    this.renderCardBacks();
                    
                    document.getElementById('result-controls').classList.add('hidden');
                    document.getElementById('betting-controls').classList.remove('hidden');
                    document.getElementById('result').innerHTML = '&nbsp;';
                    
                    this.updateDisplay();
                } else {
                    document.getElementById('result').textContent = 'GAME OVER - No Credits!';
                }
            }

            renderCardBacks() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.justifyContent = 'center';
                cardsArea.style.alignItems = 'center';
                cardsArea.style.gap = '60px';
                
                // Dealer section with 2 card backs
                const dealerSection = document.createElement('div');
                dealerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const dealerLabel = document.createElement('div');
                dealerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                dealerLabel.textContent = 'DEALER';
                dealerSection.appendChild(dealerLabel);
                
                const dealerRow = document.createElement('div');
                dealerRow.style.cssText = 'display: flex; gap: 8px;';
                dealerRow.appendChild(createCardBack(280, 400));
                dealerRow.appendChild(createCardBack(280, 400));
                dealerSection.appendChild(dealerRow);
                
                cardsArea.appendChild(dealerSection);
                
                // Player section with 2 card backs
                const playerSection = document.createElement('div');
                playerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const playerLabel = document.createElement('div');
                playerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                playerLabel.textContent = 'PLAYER';
                playerSection.appendChild(playerLabel);
                
                const playerRow = document.createElement('div');
                playerRow.style.cssText = 'display: flex; gap: 8px;';
                playerRow.appendChild(createCardBack(280, 400));
                playerRow.appendChild(createCardBack(280, 400));
                playerSection.appendChild(playerRow);
                
                cardsArea.appendChild(playerSection);
            }

            updateDisplay() {
                // Hide pay table for blackjack
                const payTable = document.getElementById('pay-table');
                if (payTable) {
                    payTable.style.display = 'none';
                }

                // Info bar
                document.getElementById('info-bar').innerHTML = '';
                
                // Update cash displays
                const cashDisplays = ['game-cash-display', 'game-cash-display-hold', 'game-cash-display-result'];
                cashDisplays.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.textContent = this.cash;
                });
            }

            renderCards() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.opacity = '1';
                cardsArea.style.transition = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.flexDirection = 'row';
                cardsArea.style.justifyContent = 'center';
                cardsArea.style.alignItems = 'center';
                cardsArea.style.gap = '60px';
                
                // Calculate card size based on number of cards
                const maxCards = Math.max(this.playerHand.length, this.dealerHand.length);
                let cardWidth, cardHeight, fontSize;
                if (maxCards >= 6) {
                    cardWidth = 180;
                    cardHeight = 260;
                    fontSize = 60;
                } else if (maxCards >= 4) {
                    cardWidth = 220;
                    cardHeight = 320;
                    fontSize = 75;
                } else {
                    cardWidth = 280;
                    cardHeight = 400;
                    fontSize = 96;
                }
                
                // Dealer's section
                const dealerSection = document.createElement('div');
                dealerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                
                const dealerLabel = document.createElement('div');
                dealerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                dealerLabel.textContent = 'DEALER';
                dealerSection.appendChild(dealerLabel);
                
                const dealerRow = document.createElement('div');
                dealerRow.style.cssText = 'display: flex; gap: 8px;';
                
                this.dealerHand.forEach((card, i) => {
                    const container = this.createCardElement(card, i + 100, i > 0 && !this.dealerRevealed, cardWidth, cardHeight, fontSize);
                    dealerRow.appendChild(container);
                });
                dealerSection.appendChild(dealerRow);
                
                // Dealer's hand total
                const dealerTotal = document.createElement('div');
                dealerTotal.style.cssText = 'text-align: center; color: #FFFF00; font-size: 48px; font-weight: bold; margin-top: 10px;';
                if (this.dealerRevealed) {
                    dealerTotal.textContent = this.getHandValue(this.dealerHand);
                } else {
                    // Show only the value of the first (visible) card
                    dealerTotal.textContent = this.getHandValue([this.dealerHand[0]]);
                }
                dealerSection.appendChild(dealerTotal);
                
                cardsArea.appendChild(dealerSection);
                
                // Player's section
                if (!this.isSplit) {
                    // Regular single hand
                    const playerSection = document.createElement('div');
                    playerSection.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                    
                    const playerLabel = document.createElement('div');
                    playerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                    playerLabel.textContent = 'PLAYER';
                    playerSection.appendChild(playerLabel);
                    
                    const playerRow = document.createElement('div');
                    playerRow.style.cssText = 'display: flex; gap: 8px;';
                    
                    this.playerHand.forEach((card, i) => {
                        const container = this.createCardElement(card, i, false, cardWidth, cardHeight, fontSize);
                        playerRow.appendChild(container);
                    });
                    
                    playerSection.appendChild(playerRow);
                    
                    // Player's hand total
                    const playerTotal = document.createElement('div');
                    playerTotal.style.cssText = 'text-align: center; color: #FFFF00; font-size: 48px; font-weight: bold; margin-top: 10px;';
                    playerTotal.textContent = this.playerHand.length > 0 ? this.getHandValue(this.playerHand) : '-';
                    playerSection.appendChild(playerTotal);
                    
                    cardsArea.appendChild(playerSection);
                } else {
                    // Split hands - show both
                    for (let handIndex = 0; handIndex < 2; handIndex++) {
                        const playerSection = document.createElement('div');
                        const isActive = handIndex === this.currentHandIndex && this.state === 'playing';
                        playerSection.style.cssText = `display: flex; flex-direction: column; align-items: center; ${isActive ? 'opacity: 1;' : 'opacity: 0.6;'}`;
                        
                        const playerLabel = document.createElement('div');
                        playerLabel.style.cssText = 'text-align: center; color: #AAAAFF; font-size: 32px; font-weight: bold; margin-bottom: 10px;';
                        playerLabel.textContent = `HAND ${handIndex + 1}${isActive ? ' (Active)' : ''}`;
                        playerSection.appendChild(playerLabel);
                        
                        const playerRow = document.createElement('div');
                        playerRow.style.cssText = 'display: flex; gap: 8px;';
                        
                        this.splitHands[handIndex].forEach((card, i) => {
                            const container = this.createCardElement(card, i + (handIndex * 10), false, cardWidth, cardHeight, fontSize);
                            playerRow.appendChild(container);
                        });
                        
                        playerSection.appendChild(playerRow);
                        
                        // Hand total
                        const handTotal = document.createElement('div');
                        handTotal.style.cssText = 'text-align: center; color: #FFFF00; font-size: 48px; font-weight: bold; margin-top: 10px;';
                        handTotal.textContent = this.getHandValue(this.splitHands[handIndex]);
                        playerSection.appendChild(handTotal);
                        
                        cardsArea.appendChild(playerSection);
                    }
                }
                
                this.cardsToAnimate = [];
            }

            createCardElement(card, index, faceDown, width = 280, height = 400, centerFontSize = 96) {
                const container = document.createElement('div');
                container.style.cssText = 'text-align: center; position: relative;';
                
                const cardDiv = document.createElement('div');
                const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                
                const shouldAnimate = this.cardsToAnimate.includes(index);
                if (shouldAnimate) {
                    cardDiv.className = 'card-dealing';
                }
                
                if (faceDown) {
                    // Face down card - use proper card back
                    const cardBack = createCardBack(width, height);
                    if (shouldAnimate) {
                        cardBack.className = 'card-dealing';
                        cardBack.style.animationDelay = `${(index % 100) * 0.15}s`;
                    }
                    container.appendChild(cardBack);
                    return container;
                } else {
                    // Scale font sizes proportionally
                    const topFontSize = Math.floor(width * 0.21);
                    const topSuitSize = Math.floor(width * 0.16);
                    const bottomFontSize = Math.floor(width * 0.086);
                    const bottomSuitSize = Math.floor(width * 0.071);
                    
                    // Face up card
                    cardDiv.style.cssText = `
                        width: ${width}px;
                        height: ${height}px;
                        background: #FFFFFF;
                        border: 3px solid #333;
                        border-radius: 8px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        padding: 8px 6px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                        overflow: hidden;
                        ${shouldAnimate ? `animation-delay: ${(index % 100) * 0.15}s;` : ''}
                    `;
                    
                    const topCorner = document.createElement('div');
                    topCorner.style.cssText = `
                        text-align: left;
                        line-height: 1;
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    topCorner.innerHTML = `
                        <div style="font-size: ${topFontSize}px; font-weight: bold;">${card.rank}</div>
                        <div style="font-size: ${topSuitSize}px;">${card.suit}</div>
                    `;
                    
                    const centerSuit = document.createElement('div');
                    centerSuit.style.cssText = `
                        text-align: center;
                        font-size: ${centerFontSize}px;
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    centerSuit.textContent = card.suit;
                    
                    const bottomCorner = document.createElement('div');
                    bottomCorner.style.cssText = `
                        text-align: right;
                        line-height: 1;
                        transform: rotate(180deg);
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    bottomCorner.innerHTML = `
                        <div style="font-size: ${bottomFontSize}px; font-weight: bold;">${card.rank}</div>
                        <div style="font-size: ${bottomSuitSize}px;">${card.suit}</div>
                    `;
                    
                    cardDiv.appendChild(topCorner);
                    cardDiv.appendChild(centerSuit);
                    cardDiv.appendChild(bottomCorner);
                }
                
                container.appendChild(cardDiv);
                return container;
            }

            draw() {
                this.hit();
            }
        }

        class VideoPokerGame {
            constructor(gameType) {
                this.gameType = gameType;
                this.deck = new Deck();
                this.hand = [];
                this.held = [false, false, false, false, false];
                this.bet = 1;
                this.cash = globalCash;
                this.state = 'betting'; // betting, holding, result
                this.cardsToAnimate = [];
                this.payTable = PAY_TABLES[gameType];
            }

            setBet(amount) {
                if (this.state !== 'betting') return;
                if (amount > this.cash) {
                    document.getElementById('result').textContent = 'Insufficient Credits!';
                    return;
                }
                this.bet = amount;
                this.updateDisplay();
                updateBetDisplay();
            }

            deal() {
                if (this.state !== 'betting' || this.bet > this.cash) return;
                
                this.cash -= this.bet;
                globalCash = this.cash;
                updateHomeCash();
                
                this.deck.reset();
                this.hand = this.deck.deal(5);
                this.held = [false, false, false, false, false];
                this.cardsToAnimate = [0, 1, 2, 3, 4];
                this.state = 'holding';
                
                // Play card dealing sound
                if (window.casinoSounds) {
                    window.casinoSounds.cardDeal();
                }
                
                document.getElementById('betting-controls').classList.add('hidden');
                document.getElementById('holding-controls').classList.remove('hidden');
                document.getElementById('result').textContent = 'Select cards to HOLD';
                
                this.renderCards();
                this.updateDisplay();
            }

            toggleHold(index) {
                if (this.state !== 'holding') return;
                this.held[index] = !this.held[index];
                
                // Play hold sound
                if (window.casinoSounds) {
                    window.casinoSounds.cardHold();
                }
                
                this.renderCards();
            }

            draw() {
                if (this.state !== 'holding') return;
                
                // Play draw sound
                if (window.casinoSounds) {
                    window.casinoSounds.cardDraw();
                }
                
                this.cardsToAnimate = [];
                for (let i = 0; i < 5; i++) {
                    if (!this.held[i]) {
                        this.hand[i] = this.deck.deal(1)[0];
                        this.cardsToAnimate.push(i);
                    }
                }
                
                this.state = 'result';
                this.held = [false, false, false, false, false];
                
                document.getElementById('holding-controls').classList.add('hidden');
                document.getElementById('result-controls').classList.remove('hidden');
                
                this.renderCards();
                this.evaluateHand();
            }

            evaluateHand() {
                const handType = this.getHandType();
                let winAmount = 0;
                
                if (handType && this.payTable[handType]) {
                    winAmount = this.payTable[handType][this.bet - 1];
                    this.cash += winAmount;
                    globalCash = this.cash;
                    updateHomeCash();
                    document.getElementById('result').textContent = `${handType}! WIN $${winAmount}`;
                    
                    // Play appropriate sound based on hand strength
                    if (window.casinoSounds) {
                        const bigWinHands = ['Royal Flush', 'Natural Royal Flush', 'Four Deuces', 'Straight Flush', 'Four of a Kind', 'Full House', 'Wild Royal Flush', 'Five of a Kind'];
                        if (bigWinHands.includes(handType)) {
                            // Royal flush gets jackpot sound
                            if (handType === 'Royal Flush' || handType === 'Natural Royal Flush' || handType === 'Four Deuces') {
                                window.casinoSounds.jackpot();
                            } else {
                                window.casinoSounds.bigWin();
                            }
                        } else {
                            window.casinoSounds.smallWin();
                        }
                    }
                    
                    // Track stats
                    if (window.stats && window.stats.gameResult) {
                        window.stats.gameResult(this.gameType, this.bet, `${handType}! WIN`, winAmount, this.hand, null);
                    }
                    if (window.stats && window.stats.handPlayed) {
                        window.stats.handPlayed(this.gameType, handType, this.bet, winAmount);
                    }
                } else {
                    document.getElementById('result').textContent = 'No Win';
                    
                    // Play lose sound
                    if (window.casinoSounds) {
                        window.casinoSounds.lose();
                    }
                    
                    // Track loss
                    if (window.stats && window.stats.gameResult) {
                        window.stats.gameResult(this.gameType, this.bet, 'No Win', 0, this.hand, null);
                    }
                }
                
                this.updateDisplay();
            }

            getHandType() {
                const ranks = this.hand.map(c => c.rank);
                const suits = this.hand.map(c => c.suit);
                const values = this.hand.map(c => c.value).sort((a, b) => a - b);
                
                // Count deuces for Deuces Wild
                const deuceCount = this.gameType === 'deuces' ? ranks.filter(r => r === '2').length : 0;
                
                // Check for flush
                const isFlush = suits.every(s => s === suits[0]);
                
                // Check for straight
                const isStraight = this.gameType === 'deuces' ? 
                    this.checkStraightWithWilds(values, deuceCount) : 
                    this.checkStraight(values);
                const isWheelStraight = values.join(',') === '2,3,4,5,14'; // A-2-3-4-5
                const actualStraight = isStraight || isWheelStraight;
                
                // Count rank frequencies
                const rankCounts = {};
                for (let rank of ranks) {
                    rankCounts[rank] = (rankCounts[rank] || 0) + 1;
                }
                const counts = Object.values(rankCounts).sort((a, b) => b - a);
                
                if (this.gameType === 'deuces') {
                    return this.evaluateDeucesWild(ranks, suits, values, isFlush, actualStraight, rankCounts, deuceCount);
                } else {
                    return this.evaluateJacksOrBetter(ranks, suits, values, isFlush, actualStraight, rankCounts, counts);
                }
            }

            evaluateJacksOrBetter(ranks, suits, values, isFlush, isStraight, rankCounts, counts) {
                // Royal Flush
                if (isFlush && isStraight && values[0] === 10) {
                    return 'Royal Flush';
                }
                
                // Straight Flush
                if (isFlush && isStraight) {
                    return 'Straight Flush';
                }
                
                // Four of a Kind
                if (counts[0] === 4) {
                    return 'Four of a Kind';
                }
                
                // Full House
                if (counts[0] === 3 && counts[1] === 2) {
                    return 'Full House';
                }
                
                // Flush
                if (isFlush) {
                    return 'Flush';
                }
                
                // Straight
                if (isStraight) {
                    return 'Straight';
                }
                
                // Three of a Kind
                if (counts[0] === 3) {
                    return 'Three of a Kind';
                }
                
                // Two Pair
                if (counts[0] === 2 && counts[1] === 2) {
                    return 'Two Pair';
                }
                
                // Jacks or Better (pair of J, Q, K, or A)
                if (counts[0] === 2) {
                    for (let rank in rankCounts) {
                        if (rankCounts[rank] === 2 && ['J', 'Q', 'K', 'A'].includes(rank)) {
                            return 'Jacks or Better';
                        }
                    }
                }
                
                return null;
            }

            evaluateDeucesWild(ranks, suits, values, isFlush, isStraight, rankCounts, deuceCount) {
                // Natural Royal Flush (no deuces)
                if (deuceCount === 0 && isFlush && isStraight && values[0] === 10) {
                    return 'Natural Royal Flush';
                }
                
                // Four Deuces
                if (deuceCount === 4) {
                    return 'Four Deuces';
                }
                
                // With wilds, we need to check what the best hand is
                const nonDeuceRanks = ranks.filter(r => r !== '2');
                const nonDeuceCounts = {};
                for (let rank of nonDeuceRanks) {
                    nonDeuceCounts[rank] = (nonDeuceCounts[rank] || 0) + 1;
                }
                const sortedCounts = Object.values(nonDeuceCounts).sort((a, b) => b - a);
                const maxCount = sortedCounts[0] || 0;
                
                // Wild Royal Flush (with deuces)
                if (deuceCount > 0 && isFlush && isStraight && (values[4] === 14 || deuceCount >= 1)) {
                    // Check if we can make a royal with deuces
                    const royalRanks = [10, 11, 12, 13, 14];
                    const nonDeuceValues = values.filter(v => v !== 2);
                    const canMakeRoyal = royalRanks.filter(r => nonDeuceValues.includes(r) || deuceCount > 0).length === 5;
                    if (canMakeRoyal && isFlush) {
                        return 'Wild Royal Flush';
                    }
                }
                
                // Five of a Kind (only possible with deuces)
                if (maxCount + deuceCount >= 5) {
                    return 'Five of a Kind';
                }
                
                // Straight Flush
                if (isFlush && isStraight) {
                    return 'Straight Flush';
                }
                
                // Four of a Kind
                if (maxCount + deuceCount >= 4) {
                    return 'Four of a Kind';
                }
                
                // Full House (three of one kind + pair of another, using wilds)
                if (deuceCount === 0 && sortedCounts[0] === 3 && sortedCounts[1] === 2) {
                    return 'Full House';
                }
                if (deuceCount === 1 && sortedCounts[0] === 2 && sortedCounts[1] === 2) {
                    return 'Full House';
                }
                if (deuceCount >= 1 && maxCount === 2) {
                    // Check if we have two pairs or can make full house
                    if (sortedCounts.length >= 2 && sortedCounts[0] === 2 && sortedCounts[1] === 2) {
                        return 'Full House';
                    }
                }
                
                // Flush
                if (isFlush) {
                    return 'Flush';
                }
                
                // Straight
                if (isStraight) {
                    return 'Straight';
                }
                
                // Three of a Kind
                if (maxCount + deuceCount >= 3) {
                    return 'Three of a Kind';
                }
                
                return null;
            }

            checkStraight(values) {
                for (let i = 0; i < values.length - 1; i++) {
                    if (values[i + 1] - values[i] !== 1) {
                        return false;
                    }
                }
                return true;
            }

            checkStraightWithWilds(values, deuceCount) {
                if (deuceCount === 0) {
                    // No wilds - use regular straight check
                    for (let i = 0; i < values.length - 1; i++) {
                        if (values[i + 1] - values[i] !== 1) {
                            return false;
                        }
                    }
                    return true;
                }
                
                // Special case: Check for wheel (A-2-3-4-5) with wild
                const hasAce = values.includes(14);
                if (hasAce) {
                    const wheelValues = values.map(v => v === 14 ? 1 : v).sort((a, b) => a - b);
                    const wheelNonDeuces = wheelValues.filter(v => v !== 2);
                    
                    if (wheelNonDeuces.length > 0 && wheelNonDeuces[wheelNonDeuces.length - 1] <= 5) {
                        let needed = 0;
                        const wheelTarget = [1, 2, 3, 4, 5];
                        for (const target of wheelTarget) {
                            if (!wheelNonDeuces.includes(target)) {
                                needed++;
                            }
                        }
                        if (needed <= deuceCount) {
                            return true;
                        }
                    }
                }
                
                // Get non-deuce values
                const nonDeuceValues = values.filter(v => v !== 2).sort((a, b) => a - b);
                
                if (nonDeuceValues.length === 0) {
                    return true; // All wilds
                }
                
                // Try to make a straight starting from the minimum non-deuce value
                for (let start = nonDeuceValues[0]; start <= nonDeuceValues[0]; start++) {
                    const straightNeeded = [start, start + 1, start + 2, start + 3, start + 4];
                    let wildNeeded = 0;
                    let valid = true;
                    
                    for (const val of straightNeeded) {
                        if (!nonDeuceValues.includes(val)) {
                            wildNeeded++;
                        }
                    }
                    
                    // Check if all non-deuce cards fit in this straight
                    for (const val of nonDeuceValues) {
                        if (val < start || val > start + 4) {
                            valid = false;
                            break;
                        }
                    }
                    
                    if (valid && wildNeeded <= deuceCount) {
                        return true;
                    }
                }
                
                return false;
            }

            newGame() {
                if (this.cash >= 1) {
                    this.state = 'betting';
                    this.bet = Math.min(this.bet, this.cash);
                    
                    // Show card backs instead of clearing
                    this.renderCardBacks();
                    
                    document.getElementById('result-controls').classList.add('hidden');
                    document.getElementById('betting-controls').classList.remove('hidden');
                    document.getElementById('result').textContent = 'Select cards to HOLD';
                    
                    this.updateDisplay();
                } else {
                    document.getElementById('result').textContent = 'GAME OVER - No Credits!';
                }
            }

            renderCardBacks() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.justifyContent = 'center';
                cardsArea.style.gap = '10px';
                
                for (let i = 0; i < 5; i++) {
                    const container = document.createElement('div');
                    container.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                    
                    // Add spacer for HELD label (same height as when cards are dealt)
                    const heldSpacer = document.createElement('div');
                    heldSpacer.style.cssText = 'height: 32px; margin-bottom: 5px;';
                    heldSpacer.innerHTML = '&nbsp;';
                    
                    const cardBack = createCardBack(280, 400);
                    
                    container.appendChild(heldSpacer);
                    container.appendChild(cardBack);
                    
                    cardsArea.appendChild(container);
                }
            }

            updateDisplay() {
                // Pay table
                let payTableHTML = '';
                const hands = Object.keys(this.payTable);
                
                // Make sure pay table is visible
                const payTable = document.getElementById('pay-table');
                if (payTable) {
                    payTable.style.display = 'inline-block';
                }
                
                hands.forEach(hand => {
                    let line = hand.toUpperCase().padEnd(22, '.') + '  ';
                    for (let i = 0; i < 5; i++) {
                        const payout = this.payTable[hand][i].toString().padStart(5, ' ');
                        if (i === this.bet - 1) {
                            line += `<span class="highlight">${payout}</span>`;
                        } else {
                            line += payout;
                        }
                        if (i < 4) line += ' |';
                    }
                    payTableHTML += line + '\n';
                });
                
                document.getElementById('pay-table').innerHTML = payTableHTML;

                // Info bar
                document.getElementById('info-bar').innerHTML = '';
                
                // Update cash displays
                const cashDisplays = ['game-cash-display', 'game-cash-display-hold', 'game-cash-display-result'];
                cashDisplays.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.textContent = this.cash;
                });
            }

            renderCards() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.opacity = '1';
                cardsArea.style.transition = '';
                
                if (this.hand.length === 0) return;
                
                this.hand.forEach((card, i) => {
                    const container = document.createElement('div');
                    container.style.cssText = `
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        margin: 0 10px;
                    `;
                    
                    // Held label
                    const heldLabel = document.createElement('div');
                    heldLabel.textContent = this.held[i] ? 'HELD' : '';
                    heldLabel.style.cssText = `
                        color: #FFFFFF;
                        font-size: 24px;
                        font-weight: bold;
                        height: 32px;
                        margin-bottom: 5px;
                    `;
                    
                    // Card
                    const cardDiv = document.createElement('div');
                    const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                    const held = this.held[i];
                    
                    const shouldAnimate = this.cardsToAnimate.includes(i);
                    if (shouldAnimate) {
                        cardDiv.className = 'card-dealing';
                    }
                    
                    const shouldRaise = held && this.state === 'holding';
                    
                    cardDiv.style.cssText = `
                        width: 280px;
                        height: 400px;
                        background: #FFFFFF;
                        border: 5px solid #333;
                        border-radius: 12px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        padding: 12px 10px;
                        cursor: pointer;
                        box-shadow: ${'0 4px 8px rgba(0,0,0,0.3)'};
                        transition: all 0.3s ease;
                        overflow: hidden;
                        transform: translateY(0);
                        ${shouldAnimate ? `animation-delay: ${i * 0.1}s;` : ''}
                    `;
                    
                    cardDiv.onclick = () => {
                        if (this.state === 'holding') {
                            this.toggleHold(i);
                        }
                    };
                    
                    // Top left corner
                    const topCorner = document.createElement('div');
                    topCorner.style.cssText = `
                        text-align: left;
                        line-height: 1;
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    topCorner.innerHTML = `
                        <div style="font-size: 64px; font-weight: bold;">${card.rank}</div>
                        <div style="font-size: 48px;">${card.suit}</div>
                    `;
                    
                    // Center suit (or WILD for deuces in Deuces Wild)
                    const centerSuit = document.createElement('div');
                    const isDeuce = this.gameType === 'deuces' && card.rank === '2';
                    centerSuit.style.cssText = `
                        text-align: center;
                        font-size: ${isDeuce ? '48px' : '96px'};
                        color: ${isRed ? '#DD0000' : '#000000'};
                        font-weight: ${isDeuce ? 'bold' : 'normal'};
                    `;
                    centerSuit.textContent = isDeuce ? 'WILD' : card.suit;
                    
                    // Bottom right corner (upside down)
                    const bottomCorner = document.createElement('div');
                    bottomCorner.style.cssText = `
                        text-align: right;
                        line-height: 1;
                        transform: rotate(180deg);
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    bottomCorner.innerHTML = `
                        <div style="font-size: 64px; font-weight: bold;">${card.rank}</div>
                        <div style="font-size: 48px;">${card.suit}</div>
                    `;
                    
                    cardDiv.appendChild(topCorner);
                    cardDiv.appendChild(centerSuit);
                    cardDiv.appendChild(bottomCorner);
                    
                    
                    container.appendChild(heldLabel);
                    container.appendChild(cardDiv);
                    cardsArea.appendChild(container);
                });
                
                this.cardsToAnimate = [];
            }
        }

        class MultiHandPokerGame {
            constructor() {
                this.deck = new Deck();
                this.hands = [];
                this.baseHand = [];
                this.held = [false, false, false, false, false];
                this.bet = 1;
                this.cash = globalCash;
                this.state = 'betting';
                this.gameType = 'jacks';
                this.payTable = PAY_TABLES.jacks;
                this.cardsToAnimate = [];
                this.handResults = [];
            }

            getNumHands() {
                return (this.bet * 5) + 1;
            }

            setBet(amount) {
                if (this.state !== 'betting') return;
                const numHands = (amount * 5) + 1;
                if (amount > this.cash || amount * numHands > this.cash) {
                    document.getElementById('result').textContent = 'Insufficient Credits!';
                    return;
                }
                this.bet = amount;
                
                this.updateDisplay();
                this.renderCardBacks();
            }

            deal() {
                const numHands = this.getNumHands();
                const totalBet = this.bet * numHands;
                if (this.state !== 'betting' || totalBet > this.cash) return;
                
                this.cash -= totalBet;
                globalCash = this.cash;
                updateHomeCash();
                
                this.deck.reset();
                this.baseHand = this.deck.deal(5);
                
                this.hands = [];
                for (let i = 0; i < numHands; i++) {
                    this.hands.push([...this.baseHand]);
                }
                
                this.held = [false, false, false, false, false];
                this.state = 'holding';
                this.handResults = [];
                
                document.getElementById('betting-controls').classList.add('hidden');
                document.getElementById('holding-controls').classList.remove('hidden');
                document.getElementById('result').innerHTML = 'Select cards to HOLD';
                
                this.renderCards();
                this.updateDisplay();
            }

            toggleHold(cardIndex) {
                if (this.state !== 'holding') return;
                this.held[cardIndex] = !this.held[cardIndex];
                this.renderCards();
            }

            draw() {
                if (this.state !== 'holding') return;
                
                this.state = 'result';
                
                // Calculate how many cards we need
                const numHeld = this.held.filter(h => h).length;
                const cardsNeededPerHand = 5 - numHeld;
                const totalCardsNeeded = cardsNeededPerHand * this.hands.length;
                
                // Deal all cards at once
                const newCards = this.deck.deal(totalCardsNeeded);
                let cardIndex = 0;
                
                // Distribute to hands
                for (let handIdx = 0; handIdx < this.hands.length; handIdx++) {
                    for (let pos = 0; pos < 5; pos++) {
                        if (!this.held[pos]) {
                            this.hands[handIdx][pos] = newCards[cardIndex % newCards.length];
                            cardIndex++;
                        }
                    }
                }
                
                this.evaluateAllHands();
                this.renderCards();
            }

            evaluateAllHands() {
                let totalWin = 0;
                this.handResults = [];
                
                for (let handIdx = 0; handIdx < this.hands.length; handIdx++) {
                    const handType = this.getHandType(this.hands[handIdx]);
                    let winAmount = 0;
                    
                    if (handType && this.payTable[handType]) {
                        winAmount = this.payTable[handType][this.bet - 1];
                        totalWin += winAmount;
                        
                        if (window.stats && window.stats.handPlayed) {
                            window.stats.handPlayed('multihand', handType, this.bet, winAmount);
                        }
                    }
                    
                    this.handResults[handIdx] = { handType, winAmount };
                }
                
                if (window.stats && window.stats.gameResult) {
                    const numHands = this.getNumHands();
                    window.stats.gameResult('multihand', this.bet * numHands, totalWin > 0 ? 'WIN' : 'LOSS', totalWin, this.baseHand, null);
                }
                
                this.cash += totalWin;
                globalCash = this.cash;
                updateHomeCash();
                
                document.getElementById('result').textContent = totalWin > 0 ? `TOTAL WIN: $${totalWin}` : 'No Wins';
                
                document.getElementById('holding-controls').classList.add('hidden');
                document.getElementById('result-controls').classList.remove('hidden');
                
                this.updateDisplay();
            }

            getHandType(hand) {
                const ranks = hand.map(c => c.rank);
                const suits = hand.map(c => c.suit);
                const values = hand.map(c => c.value).sort((a, b) => a - b);
                
                const isFlush = suits.every(s => s === suits[0]);
                const isStraight = this.checkStraight(values);
                const isWheelStraight = values.join(',') === '2,3,4,5,14';
                const actualStraight = isStraight || isWheelStraight;
                
                const rankCounts = {};
                for (let rank of ranks) {
                    rankCounts[rank] = (rankCounts[rank] || 0) + 1;
                }
                const counts = Object.values(rankCounts).sort((a, b) => b - a);
                
                if (isFlush && actualStraight && values[0] === 10) return 'Royal Flush';
                if (isFlush && actualStraight) return 'Straight Flush';
                if (counts[0] === 4) return 'Four of a Kind';
                if (counts[0] === 3 && counts[1] === 2) return 'Full House';
                if (isFlush) return 'Flush';
                if (actualStraight) return 'Straight';
                if (counts[0] === 3) return 'Three of a Kind';
                if (counts[0] === 2 && counts[1] === 2) return 'Two Pair';
                if (counts[0] === 2) {
                    const pairRank = Object.keys(rankCounts).find(r => rankCounts[r] === 2);
                    if (['J', 'Q', 'K', 'A'].includes(pairRank)) {
                        return 'Jacks or Better';
                    }
                }
                return null;
            }

            checkStraight(values) {
                for (let i = 0; i < values.length - 1; i++) {
                    if (values[i + 1] - values[i] !== 1) return false;
                }
                return true;
            }

            newGame() {
                this.state = 'betting';
                
                // Adjust bet if not enough cash
                const minHandsNeeded = 6; // Minimum (bet 1 = 6 hands)
                if (this.cash < minHandsNeeded) {
                    // Not enough for any bet, but don't show game over
                    this.renderCardBacks();
                    document.getElementById('result-controls').classList.add('hidden');
                    document.getElementById('betting-controls').classList.remove('hidden');
                    document.getElementById('result').innerHTML = '&nbsp;';
                    this.updateDisplay();
                    return;
                }
                
                const maxBet = Math.floor(this.cash / 6);
                this.bet = Math.min(this.bet, Math.max(1, maxBet));
                
                this.hands = [];
                this.baseHand = [];
                this.held = [false, false, false, false, false];
                this.handResults = [];
                
                this.renderCardBacks();
                
                document.getElementById('result-controls').classList.add('hidden');
                document.getElementById('betting-controls').classList.remove('hidden');
                document.getElementById('result').innerHTML = '&nbsp;';
                
                this.updateDisplay();
            }

            renderCardBacks() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.flexDirection = 'column';
                cardsArea.style.gap = '5px';
                cardsArea.style.alignItems = 'center';
                cardsArea.style.marginTop = '0px';
                
                const numHands = this.getNumHands();
                const numSmallHands = numHands - 1;
                const rows = Math.ceil(numSmallHands / 5);
                
                // Render grid - each row has 5 HANDS (each hand = 5 tiny cards)
                for (let row = 0; row < rows; row++) {
                    const rowContainer = document.createElement('div');
                    rowContainer.style.cssText = 'display: flex; gap: 2px;';
                    
                    for (let col = 0; col < 5; col++) {
                        const handIdx = row * 5 + col;
                        if (handIdx < numSmallHands) {
                            // Create a mini-hand container (5 tiny cards)
                            const miniHand = document.createElement('div');
                            miniHand.style.cssText = 'display: flex; gap: 2px;';
                            
                            for (let cardIdx = 0; cardIdx < 5; cardIdx++) {
                                miniHand.appendChild(createCardBack(58, 84));
                            }
                            
                            rowContainer.appendChild(miniHand);
                        }
                    }
                    
                    cardsArea.appendChild(rowContainer);
                }
                
                // Add base hand at bottom (5 larger cards)
                const baseHandContainer = document.createElement('div');
                baseHandContainer.style.cssText = 'display: flex; gap: 8px; margin-top: 15px;';
                
                for (let i = 0; i < 5; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                    
                    const heldLabel = document.createElement('div');
                    heldLabel.style.cssText = 'color: #FFFF00; font-size: 14px; font-weight: bold; height: 18px; margin-bottom: 3px;';
                    heldLabel.innerHTML = '&nbsp;';
                    
                    wrapper.appendChild(heldLabel);
                    wrapper.appendChild(createCardBack(170, 245));
                    baseHandContainer.appendChild(wrapper);
                }
                
                cardsArea.appendChild(baseHandContainer);
            }

            updateDisplay() {
                const numHands = this.getNumHands();
                const payTable = document.getElementById('pay-table');
                payTable.innerHTML = '';
                payTable.style.minHeight = '0';
                payTable.style.margin = '0';
                document.getElementById('info-bar').innerHTML = '';
                
                // Update cash displays
                const cashDisplays = ['game-cash-display', 'game-cash-display-hold', 'game-cash-display-result'];
                cashDisplays.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.textContent = this.cash;
                });
            }

            renderCards() {
                const cardsArea = document.getElementById('cards-area');
                cardsArea.innerHTML = '';
                cardsArea.style.display = 'flex';
                cardsArea.style.flexDirection = 'column';
                cardsArea.style.gap = '5px';
                cardsArea.style.alignItems = 'center';
                cardsArea.style.marginTop = '0px';
                
                if (this.hands.length === 0) return;
                
                const numSmallHands = this.hands.length - 1;
                const rows = Math.ceil(numSmallHands / 5);
                
                // Render grid - each position shows 5 tiny cards
                for (let row = 0; row < rows; row++) {
                    const rowContainer = document.createElement('div');
                    rowContainer.style.cssText = 'display: flex; gap: 2px;';
                    
                    for (let col = 0; col < 5; col++) {
                        const handIdx = row * 5 + col;
                        if (handIdx < numSmallHands) {
                            const hand = this.hands[handIdx];
                            const result = this.handResults[handIdx];
                            const isWinner = result && result.winAmount > 0;
                            
                            // Container for one hand (5 tiny cards)
                            const miniHand = document.createElement('div');
                            miniHand.style.cssText = `
                                display: flex;
                                gap: 2px;
                                ${isWinner ? 'filter: brightness(1.3); box-shadow: 0 0 10px rgba(255,255,0,0.8);' : ''}
                            `;
                            
                            // Render 5 tiny cards for this hand
                            hand.forEach(card => {
                                const cardDiv = document.createElement('div');
                                const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                                
                                cardDiv.style.cssText = `
                                    width: 58px;
                                    height: 84px;
                                    background: ${isWinner ? '#FFFFDD' : '#FFFFFF'};
                                    border: 1px solid ${isWinner ? '#FFFF00' : '#333'};
                                    border-radius: 3px;
                                    display: flex;
                                    flex-direction: column;
                                    padding: 4px 3px;
                                    box-shadow: ${isWinner ? '0 0 5px rgba(255,255,0,0.8)' : '0 1px 2px rgba(0,0,0,0.3)'};
                                    position: relative;
                                `;
                                
                                // Top corner
                                const topCorner = document.createElement('div');
                                topCorner.style.cssText = `
                                    position: absolute;
                                    top: 3px;
                                    left: 3px;
                                    text-align: left;
                                    line-height: 1;
                                    color: ${isRed ? '#DD0000' : '#000000'};
                                    font-size: 11px;
                                    font-weight: bold;
                                `;
                                topCorner.innerHTML = `${card.rank}<br><span style="font-size: 10px;">${card.suit}</span>`;
                                
                                // Center suit
                                const centerSuit = document.createElement('div');
                                centerSuit.style.cssText = `
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    text-align: center;
                                    font-size: 32px;
                                    color: ${isRed ? '#DD0000' : '#000000'};
                                `;
                                centerSuit.textContent = card.suit;
                                
                                // Bottom corner (rotated)
                                const bottomCorner = document.createElement('div');
                                bottomCorner.style.cssText = `
                                    position: absolute;
                                    bottom: 3px;
                                    left: 3px;
                                    text-align: left;
                                    line-height: 1;
                                    transform: rotate(180deg);
                                    color: ${isRed ? '#DD0000' : '#000000'};
                                    font-size: 10px;
                                    font-weight: bold;
                                `;
                                bottomCorner.innerHTML = `${card.rank}<br><span style="font-size: 9px;">${card.suit}</span>`;
                                
                                cardDiv.appendChild(topCorner);
                                cardDiv.appendChild(centerSuit);
                                cardDiv.appendChild(bottomCorner);
                                
                                miniHand.appendChild(cardDiv);
                            });
                            
                            // Add hand label overlaid on cards if winner
                            if (isWinner && result.handType) {
                                const handLabel = document.createElement('div');
                                handLabel.style.cssText = `
                                    position: absolute;
                                    bottom: 2px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    background: rgba(255, 255, 0, 0.95);
                                    color: #0000AA;
                                    padding: 2px 4px;
                                    font-size: 9px;
                                    font-weight: bold;
                                    border-radius: 2px;
                                    white-space: nowrap;
                                    z-index: 10;
                                `;
                                handLabel.textContent = `${result.handType} $${result.winAmount}`;
                                
                                miniHand.style.position = 'relative';
                                miniHand.appendChild(handLabel);
                            }
                            
                            rowContainer.appendChild(miniHand);
                        }
                    }
                    
                    cardsArea.appendChild(rowContainer);
                }
                
                // Render base hand at bottom
                const baseHandContainer = document.createElement('div');
                baseHandContainer.style.cssText = 'display: flex; gap: 8px; margin-top: 10px;';
                
                this.baseHand.forEach((card, cardIdx) => {
                    const cardWrapper = document.createElement('div');
                    cardWrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                    
                    const heldLabel = document.createElement('div');
                    heldLabel.textContent = this.held[cardIdx] ? 'HELD' : '';
                    heldLabel.style.cssText = 'color: #FFFF00; font-size: 26px; font-weight: bold; height: 32px; margin-bottom: 5px;';
                    
                    const cardDiv = document.createElement('div');
                    const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                    const held = this.held[cardIdx];
                    
                    cardDiv.style.cssText = `
                        width: 170px;
                        height: 245px;
                        background: ${held ? '#FFFFDD' : '#FFFFFF'};
                        border: ${held ? '5px solid #FFFF00' : '4px solid #333'};
                        border-radius: 10px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        padding: 8px 7px;
                        cursor: pointer;
                        box-shadow: ${held ? '0 0 15px rgba(255,255,0,0.6)' : '0 4px 8px rgba(0,0,0,0.3)'};
                        transition: all 0.3s ease;
                    `;
                    
                    cardDiv.onclick = () => {
                        if (this.state === 'holding') {
                            this.toggleHold(cardIdx);
                        }
                    };
                    
                    const topCorner = document.createElement('div');
                    topCorner.style.cssText = `text-align: left; line-height: 1; color: ${isRed ? '#DD0000' : '#000000'};`;
                    topCorner.innerHTML = `<div style="font-size: 34px; font-weight: bold;">${card.rank}</div><div style="font-size: 28px;">${card.suit}</div>`;
                    
                    const centerSuit = document.createElement('div');
                    centerSuit.style.cssText = `text-align: center; font-size: 72px; color: ${isRed ? '#DD0000' : '#000000'};`;
                    centerSuit.textContent = card.suit;
                    
                    const bottomCorner = document.createElement('div');
                    bottomCorner.style.cssText = `text-align: right; line-height: 1; transform: rotate(180deg); color: ${isRed ? '#DD0000' : '#000000'};`;
                    bottomCorner.innerHTML = `<div style="font-size: 34px; font-weight: bold;">${card.rank}</div><div style="font-size: 28px;">${card.suit}</div>`;
                    
                    cardDiv.appendChild(topCorner);
                    cardDiv.appendChild(centerSuit);
                    cardDiv.appendChild(bottomCorner);
                    
                    cardWrapper.appendChild(heldLabel);
                    cardWrapper.appendChild(cardDiv);
                    baseHandContainer.appendChild(cardWrapper);
                });
                
                cardsArea.appendChild(baseHandContainer);
            }
        }
        class SpinPokerGame {
    constructor() {
        this.deck = new Deck();
        this.grid = [[],[],[]]; // 3 rows x 5 columns
        this.held = [false, false, false, false, false]; // Which columns are held
        this.bet = 1;
        this.cash = globalCash;
        this.state = 'betting'; // betting, holding, result
        this.gameType = 'jacks';
        this.payTable = PAY_TABLES.jacks;
        this.cardsToAnimate = [];
    }

    setBet(amount) {
        if (this.state !== 'betting') return;
        const totalBet = amount * 3; // 3 hands
        if (totalBet > this.cash) {
            document.getElementById('result').textContent = 'Insufficient Credits!';
            return;
        }
        this.bet = amount;
                
        this.updateDisplay();
    }

    deal() {
        const totalBet = this.bet * 3;
        if (this.state !== 'betting' || totalBet > this.cash) return;
        
        this.cash -= totalBet;
        globalCash = this.cash;
        updateHomeCash();
        
        this.deck.reset();
        
        // Deal 5 cards to middle row
        this.grid[1] = this.deck.deal(5);
        this.grid[0] = [null, null, null, null, null];
        this.grid[2] = [null, null, null, null, null];
        this.held = [false, false, false, false, false];
        
        this.cardsToAnimate = [];
        this.state = 'holding';
        
        document.getElementById('betting-controls').classList.add('hidden');
        document.getElementById('holding-controls').classList.remove('hidden');
        document.getElementById('result').innerHTML = 'Select cards to HOLD';
        
        this.renderCards();
        this.updateDisplay();
    }

    toggleHold(colIndex) {
        if (this.state !== 'holding') return;
        
        this.held[colIndex] = !this.held[colIndex];
        
        // If held, copy to top and bottom rows
        if (this.held[colIndex]) {
            this.grid[0][colIndex] = this.grid[1][colIndex];
            this.grid[2][colIndex] = this.grid[1][colIndex];
        } else {
            this.grid[0][colIndex] = null;
            this.grid[2][colIndex] = null;
        }
        
        this.renderCards();
    }

    draw() {
        if (this.state !== 'holding') return;
        
        this.state = 'result';
        
        // Fill in non-held positions from remaining deck
        for (let col = 0; col < 5; col++) {
            if (!this.held[col]) {
                // Need to fill all 3 rows for this column
                const newCards = this.deck.deal(3);
                this.grid[0][col] = newCards[0];
                this.grid[1][col] = newCards[1];
                this.grid[2][col] = newCards[2];
            }
        }
        
        this.renderCards();
        this.evaluateAllHands();
    }

    evaluateAllHands() {
        let totalWin = 0;
        
        // Evaluate all 3 rows
        for (let row = 0; row < 3; row++) {
            const handType = this.getHandType(this.grid[row]);
            
            if (handType && this.payTable[handType]) {
                const winAmount = this.payTable[handType][this.bet - 1];
                totalWin += winAmount;
                
                // Track stats
                if (window.stats) {
                    window.stats.gameResult('spinpoker', this.bet, handType, winAmount, this.grid[row], null);
                    if (window.stats.handPlayed) {
                        window.stats.handPlayed('spinpoker', handType, this.bet, winAmount);
                    }
                }
            } else {
                // Track loss
                if (window.stats && window.stats.gameResult) {
                    window.stats.gameResult('spinpoker', this.bet, 'No Win', 0, this.grid[row], null);
                }
            }
        }
        
        this.cash += totalWin;
        globalCash = this.cash;
        updateHomeCash();
        
        if (totalWin > 0) {
            document.getElementById('result').textContent = `TOTAL WIN: $${totalWin}`;
        } else {
            document.getElementById('result').textContent = 'No Wins';
        }
        
        document.getElementById('holding-controls').classList.add('hidden');
        document.getElementById('result-controls').classList.remove('hidden');
        
        this.updateDisplay();
    }

    getHandType(hand) {
        const ranks = hand.map(c => c.rank);
        const suits = hand.map(c => c.suit);
        const values = hand.map(c => c.value).sort((a, b) => a - b);
        
        const isFlush = suits.every(s => s === suits[0]);
        const isStraight = this.checkStraight(values);
        const isWheelStraight = values.join(',') === '2,3,4,5,14';
        const actualStraight = isStraight || isWheelStraight;
        
        const rankCounts = {};
        for (let rank of ranks) {
            rankCounts[rank] = (rankCounts[rank] || 0) + 1;
        }
        const counts = Object.values(rankCounts).sort((a, b) => b - a);
        
        if (isFlush && actualStraight && values[0] === 10) return 'Royal Flush';
        if (isFlush && actualStraight) return 'Straight Flush';
        if (counts[0] === 4) return 'Four of a Kind';
        if (counts[0] === 3 && counts[1] === 2) return 'Full House';
        if (isFlush) return 'Flush';
        if (actualStraight) return 'Straight';
        if (counts[0] === 3) return 'Three of a Kind';
        if (counts[0] === 2 && counts[1] === 2) return 'Two Pair';
        if (counts[0] === 2) {
            const pairRank = Object.keys(rankCounts).find(r => rankCounts[r] === 2);
            if (['J', 'Q', 'K', 'A'].includes(pairRank)) {
                return 'Jacks or Better';
            }
        }
        return null;
    }

    checkStraight(values) {
        for (let i = 0; i < values.length - 1; i++) {
            if (values[i + 1] - values[i] !== 1) return false;
        }
        return true;
    }

    newGame() {
        if (this.cash >= 3) {
            this.state = 'betting';
            this.bet = Math.min(this.bet, Math.floor(this.cash / 3));
            this.grid = [[],[],[]];
            this.held = [false, false, false, false, false];
            
            // Show card backs instead of clearing
            this.renderCardBacks();
            
            document.getElementById('result-controls').classList.add('hidden');
            document.getElementById('betting-controls').classList.remove('hidden');
            document.getElementById('result').innerHTML = '&nbsp;';
            
            this.updateDisplay();
        } else {
            document.getElementById('result').textContent = 'GAME OVER - No Credits!';
        }
    }

    renderCardBacks() {
        const cardsArea = document.getElementById('cards-area');
        cardsArea.innerHTML = '';
        cardsArea.style.display = 'flex';
        cardsArea.style.flexDirection = 'column';
        cardsArea.style.gap = '10px';
        cardsArea.style.alignItems = 'center';
        
        // Show 3 rows of 5 card backs
        for (let row = 0; row < 3; row++) {
            const rowContainer = document.createElement('div');
            rowContainer.style.cssText = 'display: flex; gap: 8px;';
            
            for (let col = 0; col < 5; col++) {
                const cardBack = createCardBack(280, 400);
                rowContainer.appendChild(cardBack);
            }
            
            cardsArea.appendChild(rowContainer);
        }
    }

    updateDisplay() {
        let payTableHTML = '';
        const betIndex = this.bet - 1;
        
        for (let [hand, payouts] of Object.entries(this.payTable)) {
            const payout = payouts[betIndex];
            payTableHTML += hand.padEnd(20) + payout.toString().padStart(8) + '\n';
        }
        
        document.getElementById('pay-table').innerHTML = payTableHTML;
        document.getElementById('info-bar').innerHTML = '';
                
                // Update cash displays
                const cashDisplays = ['game-cash-display', 'game-cash-display-hold', 'game-cash-display-result'];
                cashDisplays.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.textContent = this.cash;
                });
    }

    renderCards() {
        const cardsArea = document.getElementById('cards-area');
        cardsArea.innerHTML = '';
        cardsArea.style.display = 'flex';
        cardsArea.style.flexDirection = 'column';
        cardsArea.style.gap = '10px';
        cardsArea.style.alignItems = 'center';
        
        if (!this.grid[1] || this.grid[1].length === 0) return;
        
        // Render all 3 rows
        for (let rowIdx = 0; rowIdx < 3; rowIdx++) {
            const rowContainer = document.createElement('div');
            rowContainer.style.cssText = 'display: flex; gap: 8px;';
            
            for (let colIdx = 0; colIdx < 5; colIdx++) {
                const card = this.grid[rowIdx][colIdx];
                
                if (!card) {
                    // Empty space (will be filled on draw)
                    const emptyDiv = document.createElement('div');
                    emptyDiv.style.cssText = `
                        width: 90px;
                        height: 130px;
                        background: rgba(170, 170, 255, 0.2);
                        border: 2px dashed #AAAAFF;
                        border-radius: 5px;
                    `;
                    rowContainer.appendChild(emptyDiv);
                } else {
                    const cardWrapper = document.createElement('div');
                    cardWrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
                    
                    // Held label (only show on middle row)
                    const heldLabel = document.createElement('div');
                    if (rowIdx === 1) {
                        heldLabel.textContent = this.held[colIdx] ? 'HELD' : '';
                        heldLabel.style.cssText = `
                            color: #FFFF00;
                            font-size: 14px;
                            font-weight: bold;
                            height: 18px;
                            margin-bottom: 3px;
                        `;
                    } else {
                        heldLabel.style.cssText = 'height: 18px; margin-bottom: 3px;';
                    }
                    
                    // Card
                    const cardDiv = document.createElement('div');
                    const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                    const held = this.held[colIdx];
                    
                    cardDiv.style.cssText = `
                        width: 90px;
                        height: 130px;
                        background: ${held ? '#FFFFDD' : '#FFFFFF'};
                        border: ${held ? '3px solid #FFFF00' : '2px solid #333'};
                        border-radius: 5px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        padding: 5px 4px;
                        cursor: ${rowIdx === 1 ? 'pointer' : 'default'};
                        box-shadow: ${held ? '0 0 15px rgba(255,255,0,0.6)' : '0 3px 6px rgba(0,0,0,0.3)'};
                    `;
                    
                    // Only middle row cards are clickable
                    if (rowIdx === 1) {
                        cardDiv.onclick = () => {
                            if (this.state === 'holding') {
                                this.toggleHold(colIdx);
                            }
                        };
                    }
                    
                    // Top corner
                    const topCorner = document.createElement('div');
                    topCorner.style.cssText = `
                        text-align: left;
                        line-height: 1;
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    topCorner.innerHTML = `
                        <div style="font-size: 18px; font-weight: bold;">${card.rank}</div>
                        <div style="font-size: 16px;">${card.suit}</div>
                    `;
                    
                    // Center suit
                    const centerSuit = document.createElement('div');
                    centerSuit.style.cssText = `
                        text-align: center;
                        font-size: 36px;
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    centerSuit.textContent = card.suit;
                    
                    // Bottom corner
                    const bottomCorner = document.createElement('div');
                    bottomCorner.style.cssText = `
                        text-align: right;
                        line-height: 1;
                        transform: rotate(180deg);
                        color: ${isRed ? '#DD0000' : '#000000'};
                    `;
                    bottomCorner.innerHTML = `
                        <div style="font-size: 18px; font-weight: bold;">${card.rank}</div>
                        <div style="font-size: 16px;">${card.suit}</div>
                    `;
                    
                    cardDiv.appendChild(topCorner);
                    cardDiv.appendChild(centerSuit);
                    cardDiv.appendChild(bottomCorner);
                    
                    cardWrapper.appendChild(heldLabel);
                    cardWrapper.appendChild(cardDiv);
                    rowContainer.appendChild(cardWrapper);
                }
            }
            
            cardsArea.appendChild(rowContainer);
        }
    }
}
        // Popup helper functions
        function showHandSelectPopup() {
            document.getElementById('hand-select-popup').classList.add('active');
        }

        function closeHandSelectPopup() {
            document.getElementById('hand-select-popup').classList.remove('active');
        }

        function showWinPopup(results, totalWin) {
            const listDiv = document.getElementById('win-results-list');
            listDiv.innerHTML = '';
            
            results.forEach(r => {
                const line = document.createElement('div');
                line.className = r.won ? 'win-line winner' : 'win-line';
                line.textContent = `Hand ${r.hand}: ${r.type}${r.won ? ' - $' + r.amount : ''}`;
                listDiv.appendChild(line);
            });
            
            document.getElementById('total-win-display').textContent = 
                totalWin > 0 ? `TOTAL WIN: $${totalWin}` : 'NO WINS';
            
            document.getElementById('win-results-popup').classList.add('active');
        }

        function closeWinPopup() {
            document.getElementById('win-results-popup').classList.remove('active');
            if (game && game.newGame) {
                game.newGame();
            }
        }

        let game = null;
        let soundVolume = 0.5; // 0 = off, 0.5 = medium, 1.0 = max

        function updateBetDisplay() {
            if (!game) return;
            document.getElementById('bet-amount').textContent = '$' + (game.bet || 1);
            const holdDisplay = document.getElementById('bet-amount-hold');
            if (holdDisplay) holdDisplay.textContent = '$' + (game.bet || 1);
            const resultDisplay = document.getElementById('bet-amount-result');
            if (resultDisplay) resultDisplay.textContent = '$' + (game.bet || 1);
            
            // Update game variant displays
            const gameNames = {
                'jacks': 'JACKS OR BETTER',
                'deuces': 'DEUCES WILD',
                'multihand': 'MULTI-HAND',
                'spinpoker': 'SPIN POKER',
                'blackjack': 'BLACKJACK',
                'threecard': 'THREE CARD'
            };
            const variantName = gameNames[currentGameType] || 'VIDEO POKER';
            ['game-variant-display', 'game-variant-display-hold', 'game-variant-display-result'].forEach(id => {
                const elem = document.getElementById(id);
                if (elem) elem.textContent = variantName;
            });
        }

        function betUp() {
            if (!game || game.state !== 'betting') return;
            const newBet = game.bet >= 5 ? 1 : game.bet + 1;
            game.setBet(newBet);
            updateBetDisplay();
        }

        function betMax() {
            if (!game || game.state !== 'betting') return;
            game.setBet(Math.min(5, game.cash));
            updateBetDisplay();
        }

        function toggleSound() {
            // Don't allow toggling during holding phase in video poker (key 3 holds card 3)
            if (game && game.state === 'holding' && game.toggleHold) {
                return;
            }
            
            // Cycle through: OFF (0) ‚Üí MED (0.5) ‚Üí MAX (1.0) ‚Üí OFF
            if (soundVolume === 0) {
                soundVolume = 0.5;
            } else if (soundVolume === 0.5) {
                soundVolume = 1.0;
            } else {
                soundVolume = 0;
            }
            
            // Create volume bar visualization (like signal strength bars)
            let volumeBar = '';
            const totalBars = 5;
            const activeBars = Math.floor(soundVolume * totalBars);
            
            for (let i = 0; i < totalBars; i++) {
                if (i < activeBars) {
                    volumeBar += '‚ñà';
                } else {
                    volumeBar += '‚ñë';
                }
            }
            
            // Update all SOUND buttons across all control bars
            const soundButtons = document.querySelectorAll('button[onclick*="toggleSound"]');
            soundButtons.forEach(btn => {
                if (soundVolume === 0) {
                    btn.innerHTML = `üîá&nbsp;${volumeBar}`;
                    btn.style.background = 'linear-gradient(180deg, #999 0%, #666 100%)';
                } else if (soundVolume === 0.5) {
                    btn.innerHTML = `üîâ&nbsp;${volumeBar}`;
                    btn.style.background = 'linear-gradient(180deg, #FFD700 0%, #FFA500 100%)';
                } else {
                    btn.innerHTML = `üîä&nbsp;${volumeBar}`;
                    btn.style.background = 'linear-gradient(180deg, #00FF00 0%, #00AA00 100%)';
                }
            });
            
            // Update sound volume in sounds.js
            if (window.casinoSounds) {
                window.casinoSounds.volume = soundVolume;
            }
            
            console.log('Sound:', soundVolume === 0 ? 'OFF' : soundVolume === 0.5 ? 'MEDIUM' : 'MAX');
        }

        function startGame(gameType) {
            currentGameType = gameType;
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            // Clear cards area and reset styles
            const cardsArea = document.getElementById('cards-area');
            cardsArea.innerHTML = '';
            cardsArea.style.display = '';
            cardsArea.style.flexDirection = '';
            cardsArea.style.justifyContent = '';
            cardsArea.style.alignItems = '';
            cardsArea.style.gap = '';
            
            // Set game-specific padding for cards area
            if (gameType === 'jacks' || gameType === 'deuces' || gameType === 'multihand' || gameType === 'spinpoker' || gameType === 'threecard') {
                cardsArea.style.paddingTop = '50px'; // Video poker games - cards slightly lower
                document.getElementById('result').style.top = '280px'; // Between pay table and cards
            } else if (gameType === 'blackjack' || gameType === 'baccarat') {
                cardsArea.style.paddingTop = '180px'; // Blackjack/Baccarat - cards more centered
                document.getElementById('result').style.top = '100px'; // Higher - prominent at top
            }
            
            // Reset button visibility
            document.getElementById('fold-button')?.classList.add('hidden');
            document.getElementById('stand-button')?.classList.add('hidden');
            document.getElementById('double-button')?.classList.add('hidden');
            document.getElementById('split-button')?.classList.add('hidden');
            document.getElementById('result-controls').classList.add('hidden');
            document.getElementById('holding-controls').classList.add('hidden');
            document.getElementById('betting-controls').classList.remove('hidden');
            
            if (gameType === 'jacks') {
                document.getElementById('game-variant').textContent = '[ JACKS OR BETTER ]';
                const variantText = 'JACKS OR BETTER';
                document.getElementById('game-variant-display').textContent = variantText;
                const holdVariant = document.getElementById('game-variant-display-hold');
                if (holdVariant) holdVariant.textContent = variantText;
                const resultVariant = document.getElementById('game-variant-display-result');
                if (resultVariant) resultVariant.textContent = variantText;
                document.getElementById('action-button').textContent = 'DRAW';
                document.getElementById('key-help').textContent = 'Keys: 1-5 (bet/hold) | M (max bet) | SPACE/D (deal/draw) | ENTER (continue)';
                game = new VideoPokerGame(gameType);
            } else if (gameType === 'deuces') {
                document.getElementById('game-variant').textContent = '[ DEUCES WILD ]';
                const variantText = 'DEUCES WILD';
                document.getElementById('game-variant-display').textContent = variantText;
                const holdVariant = document.getElementById('game-variant-display-hold');
                if (holdVariant) holdVariant.textContent = variantText;
                const resultVariant = document.getElementById('game-variant-display-result');
                if (resultVariant) resultVariant.textContent = variantText;
                document.getElementById('action-button').textContent = 'DRAW';
                document.getElementById('key-help').textContent = 'Keys: 1-5 (bet/hold) | M (max bet) | SPACE/D (deal/draw) | ENTER (continue)';
                game = new VideoPokerGame(gameType);
            } else if (gameType === 'multihand') {
                document.getElementById('game-variant').textContent = '[ MULTI-HAND POKER - DYNAMIC ]';
                const variantText = 'MULTI-HAND POKER - DYNAMIC';
                document.getElementById('game-variant-display').textContent = variantText;
                const holdVariant = document.getElementById('game-variant-display-hold');
                if (holdVariant) holdVariant.textContent = variantText;
                const resultVariant = document.getElementById('game-variant-display-result');
                if (resultVariant) resultVariant.textContent = variantText;
                document.getElementById('action-button').textContent = 'DRAW';
                document.getElementById('key-help').textContent = 'Keys: 1-5 (bet/hold) | M (max bet) | SPACE/D (deal/draw) | ENTER (continue)';
                game = new MultiHandPokerGame();
            } else if (gameType === 'spinpoker') {
                document.getElementById('game-variant').textContent = '[ SPIN POKER - 3 LINES ]';
                const variantText = 'SPIN POKER - 3 LINES';
                document.getElementById('game-variant-display').textContent = variantText;
                const holdVariant = document.getElementById('game-variant-display-hold');
                if (holdVariant) holdVariant.textContent = variantText;
                const resultVariant = document.getElementById('game-variant-display-result');
                if (resultVariant) resultVariant.textContent = variantText;
                document.getElementById('action-button').textContent = 'DRAW';
                document.getElementById('key-help').textContent = 'Keys: 1-5 (bet/hold) | M (max bet) | SPACE/D (deal/draw) | ENTER (continue)';
                game = new SpinPokerGame();
            } else if (gameType === 'blackjack') {
                document.getElementById('game-variant').textContent = '[ BLACKJACK - 21 ]';
                const variantText = 'BLACKJACK - 21';
                document.getElementById('game-variant-display').textContent = variantText;
                const holdVariant = document.getElementById('game-variant-display-hold');
                if (holdVariant) holdVariant.textContent = variantText;
                const resultVariant = document.getElementById('game-variant-display-result');
                if (resultVariant) resultVariant.textContent = variantText;
                document.getElementById('action-button').textContent = 'HIT';
                document.getElementById('key-help').textContent = 'Keys: H (hit) | S (stand) | D (double) | X (split) | SPACE (deal) | ENTER (continue)';
                game = new BlackjackGame();
            } else if (gameType === 'baccarat') {
                document.getElementById('game-variant').textContent = '[ BACCARAT ]';
                const variantText = 'BACCARAT';
                document.getElementById('game-variant-display').textContent = variantText;
                const holdVariant = document.getElementById('game-variant-display-hold');
                if (holdVariant) holdVariant.textContent = variantText;
                const resultVariant = document.getElementById('game-variant-display-result');
                if (resultVariant) resultVariant.textContent = variantText;
                document.getElementById('action-button').textContent = 'DEAL';
                document.getElementById('key-help').textContent = 'Keys: 1-5 (place bets) | SPACE (deal) | ENTER (continue)';
                game = new BaccaratGame();
            } else if (gameType === 'threecard') {
                document.getElementById('game-variant').textContent = '[ THREE CARD POKER ]';
                const variantText = 'THREE CARD POKER';
                document.getElementById('game-variant-display').textContent = variantText;
                const holdVariant = document.getElementById('game-variant-display-hold');
                if (holdVariant) holdVariant.textContent = variantText;
                const resultVariant = document.getElementById('game-variant-display-result');
                if (resultVariant) resultVariant.textContent = variantText;
                document.getElementById('action-button').textContent = 'PLAY';
                document.getElementById('fold-button')?.classList.remove('hidden');
                document.getElementById('key-help').textContent = 'Keys: P (play) | F (fold) | SPACE (deal) | ENTER (continue)';
                game = new ThreeCardPokerGame();
            }
            
            game.updateDisplay();
            updateBetDisplay();
            
            // Show card backs for video poker games on start
            if (game.renderCardBacks) {
                game.renderCardBacks();
            }
        }

        function returnToHome() {
            if (game) {
                globalCash = game.cash;
            }
            updateHomeCash();
            
            // Clear game display elements
            document.getElementById('cards-area').innerHTML = '';
            document.getElementById('result').textContent = '';
            document.getElementById('pay-table').innerHTML = '';
            
            document.getElementById('home-screen').style.display = 'block';
            document.getElementById('game-screen').style.display = 'none';
            game = null;
            currentGameType = null;
        }

        function updateHomeCash() {
            document.getElementById('home-cash').textContent = globalCash;
            
            // Save to Firebase (debounced to avoid too many writes)
            if (window.stats && window.stats.updateCashBalance) {
                clearTimeout(window.cashSaveTimeout);
                window.cashSaveTimeout = setTimeout(() => {
                    window.stats.updateCashBalance(globalCash);
                }, 2000); // Wait 2 seconds after last change before saving
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            
            if (!game) return;
            
            // Number keys for controls
            if (key === '1') {
                if (game.state === 'holding' && game.toggleHold) {
                    game.toggleHold(0); // Hold card 1
                    e.preventDefault();
                } else if (game.state !== 'holding') {
                    returnToHome();
                    e.preventDefault();
                }
            } else if (key === '2') {
                if (game.state === 'holding' && game.toggleHold) {
                    game.toggleHold(1); // Hold card 2
                    e.preventDefault();
                } else if (currentGameType === 'blackjack' && game.state === 'playing') {
                    game.hit(); // Hit in blackjack
                    e.preventDefault();
                } else if (currentGameType === 'baccarat' && game.state === 'betting') {
                    game.placeBet('player'); // Bet on player
                    e.preventDefault();
                } else if (game.state !== 'holding') {
                    console.log('Options - not yet implemented');
                    e.preventDefault();
                }
            } else if (key === '3') {
                if (game.state === 'holding' && game.toggleHold) {
                    game.toggleHold(2); // Hold card 3
                    e.preventDefault();
                } else if (currentGameType === 'blackjack' && game.state === 'playing') {
                    game.stand(); // Stand in blackjack
                    e.preventDefault();
                } else if (currentGameType === 'baccarat' && game.state === 'betting') {
                    game.placeBet('banker'); // Bet on banker
                    e.preventDefault();
                } else if (game.state !== 'holding') {
                    toggleSound();
                    e.preventDefault();
                }
            } else if (key === '4') {
                if (game.state === 'holding' && game.toggleHold) {
                    game.toggleHold(3); // Hold card 4
                    e.preventDefault();
                } else if (currentGameType === 'blackjack' && game.state === 'playing' && game.canDouble) {
                    game.doubleDown(); // Double in blackjack
                    e.preventDefault();
                } else if (currentGameType === 'baccarat' && game.state === 'betting') {
                    game.placeBet('tie'); // Bet on tie
                    e.preventDefault();
                } else if (game.state === 'betting') {
                    betUp();
                    e.preventDefault();
                }
            } else if (key === '5') {
                if (game.state === 'holding' && game.toggleHold) {
                    game.toggleHold(4); // Hold card 5
                    e.preventDefault();
                } else if (currentGameType === 'blackjack' && game.state === 'playing' && game.canSplit) {
                    game.split(); // Split in blackjack
                    e.preventDefault();
                } else if (currentGameType === 'baccarat' && game.state === 'betting') {
                    game.clearBets(); // Clear all bets
                    e.preventDefault();
                } else if (game.state === 'betting') {
                    betMax();
                    e.preventDefault();
                }
            }
            
            // SPACE for Deal/Draw (works in all states)
            if (key === ' ') {
                if (game.state === 'betting') {
                    game.deal();
                    // Update button text
                    const btn = document.getElementById('deal-draw-btn');
                    if (btn) btn.textContent = 'DRAW';
                    updateBetDisplay();
                    e.preventDefault();
                } else if (game.state === 'holding' && game.draw) {
                    game.draw();
                    e.preventDefault();
                } else if (game.state === 'result') {
                    game.newGame();
                    // Reset button text
                    const btn = document.getElementById('deal-draw-btn');
                    if (btn) btn.textContent = 'DEAL';
                    updateBetDisplay();
                    e.preventDefault();
                }
            }
            
            // Game-specific controls
            if (currentGameType === 'jacks' || currentGameType === 'deuces' || currentGameType === 'multihand') {
                // D key for Draw in video poker (space is handled above)
                if (key === 'd' && game.state === 'holding') {
                    game.draw();
                    e.preventDefault();
                }
            } else if (currentGameType === 'spinpoker') {
                // Same controls as video poker - hold and draw
                if ((key === 'd' || key === ' ') && game.state === 'holding') {
                    game.draw();
                    e.preventDefault();
                }
            } else if (currentGameType === 'blackjack') {
                // H for Hit
                if (key === 'h' && game.state === 'playing') {
                    game.hit();
                    e.preventDefault();
                }
                // S for Stand
                if (key === 's' && game.state === 'playing') {
                    game.stand();
                    e.preventDefault();
                }
                // D for Double Down
                if (key === 'd' && game.state === 'playing' && game.canDouble) {
                    game.doubleDown();
                    e.preventDefault();
                }
                // X for Split
                if (key === 'x' && game.state === 'playing' && game.canSplit) {
                    game.split();
                    e.preventDefault();
                }
            } else if (currentGameType === 'baccarat') {
                // Keys 1-5 place specific bets when in betting state (not holding)
                // This overrides the normal key behavior for baccarat
            } else if (currentGameType === 'threecard') {
                // P for Play
                if (key === 'p' && game.state === 'playing') {
                    game.play();
                    e.preventDefault();
                }
                // F for Fold
                if (key === 'f' && game.state === 'playing') {
                    game.fold();
                    e.preventDefault();
                }
            }
            
            // M key for Max Bet
            if (key === 'm' && game.state === 'betting') {
                game.setBet(Math.min(5, game.cash));
                e.preventDefault();
            }
        });

        // Initialize Firebase on page load
        window.addEventListener('load', async () => {
            // Always show initial cash immediately
            updateHomeCash();
            
            // Check Firebase connection
            await checkFirebaseConnection();
            
            // Load cash balance from Firebase
            if (window.stats && window.stats.getCashBalance) {
                try {
                    const firebaseCash = await window.stats.getCashBalance();
                    if (firebaseCash && !isNaN(firebaseCash)) {
                        globalCash = firebaseCash;
                        updateHomeCash();
                        console.log('üí∞ Cash loaded from Firebase: $' + globalCash);
                    }
                } catch (error) {
                    console.error('Error loading cash:', error);
                    // Use default cash if Firebase fails
                    updateHomeCash();
                }
            }
        });

        // Save cash when leaving the page
        window.addEventListener('beforeunload', () => {
            if (window.stats && window.stats.updateCashBalance) {
                window.stats.updateCashBalance(globalCash);
            }
        });

        // Secret combo detection for STATS page (type S-T-A-T-S)
        let secretCombo = '';
        let comboTimeout = null;
        
        document.addEventListener('keypress', (e) => {
            // Only track when not in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            const key = e.key.toUpperCase();
            secretCombo += key;
            
            // Reset combo after 2 seconds of no input
            clearTimeout(comboTimeout);
            comboTimeout = setTimeout(() => {
                secretCombo = '';
            }, 2000);
            
            // Check for STATS combo
            if (secretCombo.includes('STATS')) {
                secretCombo = '';
                window.location.href = 'stats.html';
            }
        });

        // Check Firebase connection and show overlay if not connected
        function checkFirebaseConnection() {
            const homeScreen = document.getElementById('home-screen');
            
            // Try to initialize Firebase
            let initialized = false;
            if (typeof initFirebase === 'function') {
                initialized = initFirebase();
            }
            
            // Check if properly configured
            if (!initialized) {
                // Firebase not configured
                homeScreen.classList.add('firebase-disconnected');
                console.warn('‚ö†Ô∏è Firebase not configured - Edit firebase-stats.js with your credentials');
            } else {
                // Firebase is connected
                homeScreen.classList.remove('firebase-disconnected');
                console.log('‚úÖ Firebase connected - Stats tracking enabled');
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Stats Integration -->
    <script src="firebase-stats.js"></script>
    
    <!-- Casino Sound Effects -->
    <script src="sounds.js"></script>
</body>
</html>
